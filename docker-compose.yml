# ============================================================
# 以图搜商品系统 · docker-compose.yml
# 完整平台: 5 微服务 + 基础设施
# ============================================================
version: "3.9"

x-common-env: &common-env
  IMGSRCH_ENV: production
  PG_DSN: postgresql://imgsrch:imgsrch_pass@postgres:5432/image_search
  PG_USER: imgsrch
  PG_PASSWORD: imgsrch_pass
  REDIS_URL: redis://redis:6379/0
  KAFKA_BROKERS: kafka:9092
  MILVUS_HOST: milvus-standalone

services:
  # ── 应用服务 ──

  search-service:
    build: services/search-service
    ports:
      - "8080:8080"
    environment:
      <<: *common-env
      IMGSRCH_SERVER__WORKERS: 4
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 8G
          cpus: "4"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      milvus-standalone:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  write-service:
    build: services/write-service
    ports:
      - "8081:8081"
    environment:
      <<: *common-env
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 4G
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  bitmap-filter-service:
    build: services/bitmap-filter-service
    ports:
      - "50051:50051"
    environment:
      <<: *common-env
      GRPC_PORT: 50051
      ROCKSDB_PATH: /data/rocksdb
      ROCKSDB_CACHE_GB: 4
      CDC_TOPIC: dbserver.public.image_merchant_bitmaps
    volumes:
      - bitmap-rocksdb:/data/rocksdb
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 16G
    depends_on:
      - kafka

  flink-jobmanager:
    image: flink:2.0.0-java21
    ports:
      - "8083:8081"
    command: jobmanager
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        state.checkpoints.dir: file:///checkpoints
    volumes:
      - flink-checkpoints:/checkpoints

  flink-taskmanager:
    image: flink:2.0.0-java21
    depends_on:
      - flink-jobmanager
    command: taskmanager
    environment:
      <<: *common-env
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 4
        taskmanager.memory.process.size: 4g
      WINDOW_SECONDS: 1
    deploy:
      replicas: 2

  cron-scheduler:
    build: services/cron-scheduler
    environment:
      <<: *common-env
    depends_on:
      postgres:
        condition: service_healthy

  # ── 基础设施 ──

  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: image_search
      POSTGRES_USER: imgsrch
      POSTGRES_PASSWORD: imgsrch_pass
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./deploy/scripts/init_db.sql:/docker-entrypoint-initdb.d/01_init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imgsrch -d image_search"]
      interval: 5s
      timeout: 3s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 4G

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 4gb --maxmemory-policy volatile-ttl
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:29093
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:29093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      CLUSTER_ID: "imgsrch-kafka-cluster-01"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka-data:/var/lib/kafka/data

  milvus-standalone:
    image: milvusdb/milvus:v2.4.0
    ports:
      - "19530:19530"
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    volumes:
      - milvus-data:/var/lib/milvus
    depends_on:
      - etcd
      - minio

  etcd:
    image: quay.io/coreos/etcd:v3.5.12
    environment:
      ETCD_AUTO_COMPACTION_RETENTION: "1"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
    command: etcd --advertise-client-urls=http://etcd:2379 --listen-client-urls=http://0.0.0.0:2379
    volumes:
      - etcd-data:/etcd

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    command: minio server /data --console-address ":9001"
    volumes:
      - minio-data:/data

  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse-data:/var/lib/clickhouse

volumes:
  postgres-data:
  redis-data:
  kafka-data:
  milvus-data:
  etcd-data:
  minio-data:
  bitmap-rocksdb:
  flink-checkpoints:
  clickhouse-data:
