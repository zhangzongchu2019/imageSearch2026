# ä»¥å›¾æœå•†å“ç³»ç»Ÿ â€” ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£

**ç‰ˆæœ¬**ï¼šv4.0.1  
**æ—¥æœŸ**ï¼š2026-02-10  
**çŠ¶æ€**ï¼šéœ€æ±‚å®šç¨¿ï¼ˆFinalï¼‰  
**é€‚ç”¨èŒƒå›´**ï¼šç ”å‘ / æµ‹è¯• / è¿ç»´ / æ¶æ„è¯„å®¡ / åˆä½œæ–¹ç ”å‘  
**å…³è”æ–‡æ¡£**ï¼šæŠ€æœ¯æ¶æ„æ–‡æ¡£ v1.2 / ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ v1.1 / ä¸šåŠ¡åä½œä¸æ²»ç†è¯´æ˜ v1.0  
**ç»Ÿè®¡å£å¾„è¯´æ˜**ï¼šæ‰€æœ‰ SLA / SLO / é”™è¯¯é¢„ç®—**ç»Ÿä¸€æŒ‰è‡ªç„¶æœˆç»Ÿè®¡**ï¼ˆ28â€“31 å¤©ï¼ŒæŒ‰å½“æœˆå®é™…å¤©æ•°è®¡ç®—ï¼‰

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

SZWEGO æ˜¯æœåŠ¡ 200-300M æ—¥æ´»ç”¨æˆ·å’Œ 4000 ä¸‡å•†å®¶çš„ B2B SaaS ç”µå•†å¹³å°ã€‚ä¸ºæå‡å¹³å°å•†å“å‘ç°æ•ˆç‡å’Œç”¨æˆ·è´­ç‰©ä½“éªŒï¼Œæ„å»º"ä»¥å›¾æœå•†å“"èƒ½åŠ›ã€‚ç”¨æˆ·ä¸Šä¼ å•†å“å›¾ç‰‡åï¼Œç³»ç»Ÿèƒ½å¤Ÿå¿«é€Ÿæ£€ç´¢å‡ºå¹³å°å†…ç›¸ä¼¼çš„å•†å“ï¼Œå¸®åŠ©ç”¨æˆ·æ‰¾åˆ°å¿ƒä»ªçš„å•†å“æˆ–åŒæ¬¾è´§æºã€‚

### 1.2 ä¸šåŠ¡ç›®æ ‡

> [è¡¨æ ¼ï¼šä¸šåŠ¡ç›®æ ‡â€”â€”å«æœç´¢è¦†ç›–ç‡ã€CTRã€è¯¢ç›˜è½¬åŒ–ã€GMVå æ¯”ç­‰æŒ‡æ ‡]

### 1.3 æ ¸å¿ƒåœºæ™¯

| åœºæ™¯ | ç”¨æˆ·è¡Œä¸º | æœŸæœ›ç»“æœ | å…¸å‹ç”¨æˆ· | å¤‡æ³¨ |
|------|---------|---------|---------|------|
| ç²¾å‡†æ‰¾åŒæ¬¾ | ä¸Šä¼ å•†å“å®æ‹å›¾ | è¿”å›ç›¸åŒæˆ–é«˜åº¦ç›¸ä¼¼å•†å“ | é‡‡è´­å•†ã€ä»£è´­ | |
| æ‰¾ç›¸ä¼¼æ¬¾å¼ | ä¸Šä¼ å–œæ¬¢çš„æ¬¾å¼å›¾ | è¿”å›é£æ ¼ã€æ¬¾å¼ç›¸è¿‘å•†å“ | ç»ˆç«¯æ¶ˆè´¹è€…ã€è®¾è®¡å¸ˆ | |
| å•†å®¶å†…æœç´¢ | åœ¨æŒ‡å®šå•†å®¶èŒƒå›´å†…ä»¥å›¾æœå›¾ | åªè¿”å›æŒ‡å®šå•†å®¶çš„ç›¸ä¼¼å•†å“ | å•†å®¶è‡ªæŸ¥ã€ä¾›åº”é“¾ç®¡ç† | å…¸å‹æŸ¥è¯¢æºå¸¦ 500-3000 ä¸ªå•†å®¶ ID |
| é•¿å°¾æŸ¥è¯¢å…œåº• | ä¸Šä¼ çš„å›¾ç‰‡åœ¨åº“ä¸­æ— ç²¾å‡†åŒ¹é… | è¿”å›åŒç±»ç›®ã€ç›¸ä¼¼é£æ ¼æ¨èå•†å“ | æ‰€æœ‰ç”¨æˆ·ï¼ˆé™çº§ä½“éªŒï¼‰ | |

### 1.4 éç›®æ ‡å£°æ˜ä¸é¡¹ç›®è¾¹ç•Œï¼ˆv3.7 æ–°å¢ï¼‰

**éç›®æ ‡ï¼ˆOut of Scopeï¼‰**ï¼š

- ä¸ä¿è¯ 100% æ‰¾åˆ°åŒæ¬¾â€”â€”å›¾æœä¸ºè¿‘ä¼¼æ£€ç´¢ç³»ç»Ÿï¼Œå—åº“å†…å•†å“è¦†ç›–åº¦å’Œå‘é‡æ¨¡å‹èƒ½åŠ›çº¦æŸ
- ä¸æ‰¿è¯ºè·¨è¡Œä¸šè¯­ä¹‰ç†è§£â€”â€”ä¸æ”¯æŒ"åƒ Dior é‚£æ ·çš„æ„Ÿè§‰"ç­‰ä¸»è§‚å®¡ç¾æè¿°
- ä¸æ”¯æŒäººå·¥å¹²é¢„å•æ¬¡æœç´¢ç»“æœâ€”â€”ä¸æä¾›"æŒ‰ç›¸ä¼¼åº¦æ’åºè§„åˆ™ç¼–è¾‘å™¨"æˆ–æ‰‹åŠ¨ç½®é¡¶/é™æƒ
- ä¸æ›¿ä»£å…³é”®è¯æœç´¢â€”â€”å›¾æœä¸ºè¾…åŠ©å‘ç°èƒ½åŠ›ï¼Œä¸æ–‡æœ¬æœç´¢äº’è¡¥è€Œéæ›¿ä»£
- ä¸æ”¯æŒè§†é¢‘å†…å®¹è¯­ä¹‰æ£€ç´¢â€”â€”ä»…æå–è§†é¢‘å…³é”®å¸§çš„é™æ€å›¾ç‰‡ç‰¹å¾ï¼Œä¸åšè§†é¢‘è¯­ä¹‰ç†è§£

**å·²çŸ¥å¾…æ‰©å±•éœ€æ±‚ï¼ˆv4.0.1 æ–°å¢ï¼‰**ï¼š

- **ä¾µæƒå›¾ç‰‡è§£ç»‘**ï¼šå½“å›¾ç‰‡å› çŸ¥è¯†äº§æƒçº çº·éœ€ä»ç‰¹å®šå•†å®¶å…³è”ä¸­ç§»é™¤æ—¶ï¼Œå½“å‰"åªè¿½åŠ ä¸åˆ é™¤"å‡è®¾æ— æ³•æ»¡è¶³ã€‚é¢„è®¡åœ¨ç³»ç»Ÿè¿è¥ 6-12 ä¸ªæœˆåè¯„ä¼°æ˜¯å¦å¯åŠ¨ DELETE èƒ½åŠ›å»ºè®¾ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œé€šè¿‡**ä¸šåŠ¡ç³»ç»Ÿä¾§å±è”½**å¤„ç†ã€‚

**å¤±è´¥å½±å“è¾¹ç•Œ**ï¼šå›¾æœç³»ç»Ÿä¸ºå¢å¼ºå‹å•†å“å‘ç°èƒ½åŠ›ï¼Œä¸æ‰¿æ‹…è®¢å•ã€åº“å­˜ã€ç»“ç®—ã€æ”¯ä»˜ç­‰äº¤æ˜“å…³é”®è·¯å¾„ã€‚åœ¨æœ€åæƒ…å†µä¸‹ï¼ˆç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨ï¼‰ï¼Œå¯¹æ ¸å¿ƒäº¤æ˜“é“¾è·¯æ— å½±å“ã€‚

**èƒ½åŠ›è´£ä»»å£°æ˜**ï¼šå›¾æœç³»ç»Ÿä»…å¯¹æ£€ç´¢èƒ½åŠ›ä¸æ’åºç­–ç•¥è´Ÿè´£ã€‚æœ€ç»ˆè½¬åŒ–æ•ˆæœï¼ˆCTRã€ä¸‹å•ç‡ã€GMVï¼‰åŒæ—¶å—å•†å“è´¨é‡ã€ä»·æ ¼ç«äº‰åŠ›ç­‰å¤šå› ç´ å½±å“ï¼Œä¸ä½œä¸ºå›¾æœç³»ç»Ÿå•æ–¹è€ƒæ ¸ä¾æ®ã€‚

### 1.5 ä¸šåŠ¡æŒ‡æ ‡ä½“ç³»

```mermaid
flowchart TD
  A["æœç´¢è¯·æ±‚ â€” 100%"] --> B["ç»“æœå±•ç¤º â€” ~98%ï¼ˆè¦†ç›–ç‡ï¼‰"]
  B --> C["ç”¨æˆ·ç‚¹å‡» â€” â‰¥35%ï¼ˆCTRâ‰¥8%ï¼‰"]
  C --> D["å‘èµ·è¯¢ç›˜ â€” â‰¥8%"]
  D --> E["æˆåŠŸä¸‹å• â€” â‰¥15%ï¼ˆè¯¢ç›˜è½¬åŒ–ï¼‰"]
  E --> F["å›¾æœGMV â€” â‰¥3%ï¼ˆå¹³å°å æ¯”ï¼‰"]
```

### 1.6 åˆ©ç›Šç›¸å…³æ–¹

> [è¡¨æ ¼ï¼šå«ç»ˆç«¯ç”¨æˆ·ã€å•†å®¶ã€ä¸šåŠ¡ç³»ç»Ÿã€äº§å“ç»ç†ã€è¿ç»´/SRE äº”ç±»è§’è‰²]

---

## äºŒã€æ•°æ®è§„æ¨¡ä¸å£å¾„

### 2.1 å›¾ç‰‡æ•°æ®è§„æ¨¡

> [è¡¨æ ¼ï¼šæ€»é‡ ~28äº¿(25äº¿æ»šåŠ¨+3äº¿å¸¸é’)ã€æœˆå¢é‡ ~1.47äº¿]

### 2.2 æ¯å›¾æœ€ä½æ•°æ®æ¨¡å‹

æ¯å¼ å›¾ç‰‡è‡³å°‘åŒ…å«ï¼šå‘é‡ 256d float32ã€å•†å®¶åˆ—è¡¨ 1-3000ä¸ªã€URI â‰¤128å­—ç¬¦ã€æ ‡ç­¾ 8-32ä¸ªã€ä¸‰çº§ç±»ç›®ã€‚

**å­˜å‚¨ä¼°ç®—**ï¼ˆå•å›¾æœ€ä½æ•°æ®ï¼Œä¸å«ç´¢å¼•å¼€é”€ï¼‰ï¼š

- å‘é‡ = 256 Ã— 4B = **1,024B** â‰ˆ 1KB
- å•†å®¶åˆ—è¡¨ = 1-3000 Ã— ~20B = **20B ~ 60KB**ï¼ˆåŸå§‹å­—ç¬¦ä¸²ï¼‰/ **4B ~ 12KB**ï¼ˆBitmapç¼–ç åï¼‰
- URI = â‰¤ **128B**
- æ ‡ç­¾ = 8-32ä¸ª Ã— ~20B = **160B ~ 640B**
- **å•å›¾åˆè®¡** â‰ˆ **1.2KB ~ 13KB**ï¼ˆBitmap ç¼–ç åï¼‰

### 2.3 å¢é‡æ•°æ®

> [è¡¨æ ¼ï¼šæœˆå¢é‡ ~1.47äº¿å›¾ã€æ—¥å¢é‡ ~490ä¸‡ã€å³°å€¼æ—¥ ~900ä¸‡]

### 2.4 å›¾ç‰‡-å•†å®¶å…³è”

æ¯å›¾å…³è”å•†å®¶æ•°è·¨è¶Šä¸‰ä¸ªæ•°é‡çº§ï¼ˆ1â†’3000ï¼‰ï¼Œå‘ˆå…¸å‹é•¿å°¾åˆ†å¸ƒã€‚æ–°å›¾ç‰‡å…¥åº“æ—¶ä»…å…³è” 1 ä¸ªå•†å®¶ï¼Œéšæ—¶é—´æ¨ç§»é€æ­¥ç§¯ç´¯ã€‚

**å•†å®¶å…³è”ä¸å¯é€†å‡è®¾å£°æ˜ï¼ˆv3.8 æ–°å¢ï¼‰**ï¼šå½“å‰ç³»ç»Ÿè®¾è®¡å‡è®¾å•†å®¶å…³è”**ä»…è¿½åŠ ã€ä¸å¯é€†**ã€‚

**åˆ†é˜¶æ®µè®¡åˆ’**ï¼š

- **å½“å‰ï¼ˆv1.0-v1.1ï¼‰**ï¼šä»…æ”¯æŒè¿½åŠ ï¼Œä¸æ”¯æŒè§£é™¤å…³è”
- **é¢„ç•™ï¼ˆv1.2+ï¼‰**ï¼šè‹¥ä¸šåŠ¡å‡ºç°éœ€æ±‚ï¼Œå¯é€šè¿‡ REMOVE äº‹ä»¶ + rb_andnot() å®ç°ï¼Œé¢„ä¼°æ”¹é€ é‡ 2-3 äººå‘¨

### 2.5 å•†å®¶è§„æ¨¡ä¸å¢é•¿é¢„æµ‹

> [è¡¨æ ¼ï¼šå½“å‰ 4000ä¸‡å•†å®¶ã€10å¹´é¢„è®¡å¢é•¿è‡³ 2äº¿]

**å•†å®¶ ID è¯´æ˜**ï¼šå•†å®¶ ID ä¸º**å­—ç¬¦ä¸²ç±»å‹**ï¼ˆç”±å•†å®¶ç³»ç»Ÿåˆ†é…ï¼‰ï¼Œç³»ç»Ÿå†…éƒ¨é€šè¿‡å­—å…¸ç¼–ç æ˜ å°„ï¼ˆstring â†’ uint32ï¼‰æ”¯æ’‘ Bitmap è¿ç®—ã€‚æ˜ å°„å±‚å¯¹ä¸šåŠ¡æ¥å£é€æ˜ã€‚

### 2.6 å›¾ç‰‡æ•°æ®æ—¶é—´åˆ†å±‚

> **v4.0 é‡æ„**ï¼šä»ä¸‰åŒºï¼ˆçƒ­/æ¸©/å†·ï¼‰æ¼”è¿›ä¸º**ä¸¤åŒºï¼ˆçƒ­åŒº + éçƒ­åŒºï¼‰**ï¼Œå¯¹é½æŠ€æœ¯æ¶æ„ v1.2 ä¸¤åŒº HNSW + DiskANN æ¶æ„ã€‚

```mermaid
flowchart TB
  subgraph TOTAL["æ•°æ®ä¿ç•™ä¸åˆ†å±‚ç­–ç•¥ (v4.0)"]
    direction TB
    subgraph EG["ğŸŸ¢ å¸¸é’èŠ‚ç‚¹ â€” â‰¤3äº¿å›¾ç‰‡ï¼ˆç¡¬ä¸Šé™ï¼‰"]
      EG1["æ…¢å˜è¡Œä¸šå›¾ç‰‡ï¼ŒæŒ‰ä¸€çº§ç±»ç›®æ•´ä½“æ ‡è®°<br/>é•¿æœŸä¿ç•™ï¼Œä¸å—18ä¸ªæœˆTTLæ·˜æ±°<br/>å­˜å‚¨äºéçƒ­åŒºï¼Œä¸çƒ­åŒºåŒç­‰å¯ç”¨æ€§ä¿éšœ<br/>å—è§„æ¨¡é¢„ç®—çº¦æŸ"]
    end
    subgraph HOT["ğŸ”´ çƒ­åŒºï¼ˆè¿‘5ä¸ªæœˆï¼‰â€” çº¦7.5äº¿å›¾ç‰‡"]
      H1["æè‡´å¯ç”¨ä¿éšœï¼ˆ99.99%ï¼‰<br/>å†…å­˜å¸¸é©»ï¼ŒHNSWé«˜é€Ÿæ£€ç´¢<br/>ä»»ä½•æ•…éšœä¸‹å¿…é¡»å¯æŸ¥<br/>æ‰¿è½½ ~80% ç”¨æˆ·æŸ¥è¯¢"]
    end
    subgraph NONHOT["ğŸ”µ éçƒ­åŒºï¼ˆ6-18ä¸ªæœˆï¼‰â€” çº¦19.5äº¿å›¾ç‰‡"]
      N1["æ‰©å±•æŸ¥è¯¢èŒƒå›´<br/>DiskANNç£ç›˜æ£€ç´¢<br/>æ•…éšœæ—¶å¯é™çº§è·³è¿‡<br/>ä»… ~20% æŸ¥è¯¢éœ€ç©¿é€"]
    end
  end
```

> **æ€»è®¡**ï¼š18ä¸ªæœˆæ»šåŠ¨ ~26.5äº¿ + å¸¸é’ â‰¤3äº¿ = æ€»è®¡ ~26.5-29.5äº¿

**åŸåˆ™è¯´æ˜**ï¼šå¸¸é’èŠ‚ç‚¹ä¸çƒ­åŒºå…±åŒæ„æˆ**ä¸šåŠ¡æ ¸å¿ƒèƒ½åŠ›æ‰¿è½½åŒº**ï¼Œä»»ä½•æ•…éšœåœºæ™¯ä¸‹å¿…é¡»å¯æŸ¥ï¼›éçƒ­åŒºæ˜¯**èƒ½åŠ›æ‰©å±•åŒº**ï¼Œå¯é€šè¿‡é™çº§ç­–ç•¥ä¸»åŠ¨æ”¾å¼ƒã€‚

### 2.7 æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†

> [è¡¨æ ¼ï¼šæ»šåŠ¨18ä¸ªæœˆTTLæ¸…ç†ã€å¸¸é’ç‹¬ç«‹æ²»ç†ã€è§†é¢‘å¸§ä¸æºè§†é¢‘åŒç”Ÿå‘½å‘¨æœŸ]

### 2.8 å¸¸é’æ± è§„æ¨¡æ²»ç†ï¼ˆv3.3 æ–°å¢ï¼‰

å¸¸é’èŠ‚ç‚¹ä¸å— 18 ä¸ªæœˆ TTL æ·˜æ±°ï¼Œä½†å— **â‰¤3 äº¿ç¡¬ä¸Šé™**è§„æ¨¡é¢„ç®—çº¦æŸã€‚

**å¸¸é’æ ‡è®°é©±åŠ¨å› å­ï¼ˆv3.4 æ˜ç¡®ï¼‰**ï¼šæŒ‰ä¸€çº§ç±»ç›®ï¼ˆcategory_l1ï¼‰æ•´ä½“åˆ‡åˆ†ï¼Œç”±äº§å“ç»ç†å®šä¹‰å¸¸é’ç±»ç›®åˆ—è¡¨ï¼ˆåªå¢ä¸å‡ï¼‰ã€‚å†™å…¥æ—¶ update-image / update-video å¿…ä¼  category_l1ï¼Œç³»ç»ŸæŸ¥è¯¢å¸¸é’ç±»ç›®é…ç½®è¡¨è‡ªåŠ¨æ¨å¯¼ is_evergreenã€‚

**æ°´ä½å®šä¹‰**ï¼š

| æ°´ä½ | é˜ˆå€¼ | è¡ŒåŠ¨ |
|------|------|------|
| ç»¿åŒº | < 2.5äº¿ | ä¸æ¸…ç† |
| é»„åŒº | 2.5-3äº¿ | æœˆåº¦å®šæœŸæ¸…ç†ï¼Œå¹´é™é€’é™ 5â†’4â†’3â†’2å¹´ |
| çº¢åŒº | â‰¥ 3äº¿ | ç«‹å³è§¦å‘æ¸…ç†è‡³ 2.5äº¿ä»¥ä¸‹ |

**æ¸…ç†è§„åˆ™**ï¼š

- æ¸…ç†æ–¹å¼ï¼šç›´æ¥åˆ é™¤ï¼ˆä»å…¨éƒ¨å­˜å‚¨å¼•æ“å½»åº•ç§»é™¤ï¼‰ï¼Œéé™çº§å›æ»šåŠ¨æ± 
- æ¸…ç†é¡ºåºï¼šæŒ‰ promoted_atï¼ˆæå‡ä¸ºå¸¸é’çš„æ—¶é—´ï¼‰å‡åº
- å¹´é™ä¸‹é™ï¼š**2 å¹´**ï¼Œä¸å¯å†é™
- å…œåº•ï¼š2å¹´ä»¥ä¸Šå…¨éƒ¨åˆ å®Œä»è¶…é™ï¼Œç­‰ä¸‹æœˆè‡ªç„¶è€åŒ–åå†æ¸…ç†ï¼Œè§¦å‘å‘Šè­¦é€šçŸ¥äººå·¥ä»‹å…¥

---

## ä¸‰ã€é¢†åŸŸæ¨¡å‹ä¸ä¸šåŠ¡æ¶æ„

> æœ¬ç« å†…å®¹æ•´åˆè‡ªåŸã€Šä¸šåŠ¡æ¶æ„æ–‡æ¡£ v1.2ã€‹ï¼Œæ¶µç›–ä¸šåŠ¡æµç¨‹ã€é¢†åŸŸå¯¹è±¡ã€çŠ¶æ€æœºã€ä¸šåŠ¡é€»è¾‘ã€å¼‚å¸¸å¤„ç†ã€æ•°æ®å®ä½“ä¸æ•°æ®æµå›¾ã€‚

### 3.1 ä¸šåŠ¡æµç¨‹

#### 3.1.1 æ ¸å¿ƒä¸šåŠ¡æµç¨‹æ€»è§ˆ

```mermaid
flowchart TB
  subgraph WriteFlow["å†™å…¥æµç¨‹ï¼ˆä¾›ç»™ä¾§ï¼‰"]
    direction LR
    ProductListing[å•†å“ä¸Šæ¶] --> UpdateImage[update-image]
    VideoUpload[è§†é¢‘ä¸Šä¼ ] --> UpdateVideo[update-video] --> ExtractFrames[æŠ½å¸§] --> UpdateImage
    BatchImport[æ‰¹é‡å¯¼å…¥] --> ImageIndex[image/index] --> DirectWrite[ç›´æ¥å†™å…¥]
    UpdateImage --> FeatureExtract[ç‰¹å¾æå–] --> VectorStore[å‘é‡å…¥åº“]
    VectorStore --> MerchantEvent[å•†å®¶å…³è”äº‹ä»¶]
    MerchantEvent --> Kafka1[Kafka] --> Flink1[Flink] --> PGBitmap[PG Bitmap] --> RocksDB1[RocksDB]
  end
  subgraph SearchFlow["æ£€ç´¢æµç¨‹ï¼ˆéœ€æ±‚ä¾§ï¼‰"]
    direction TB
    UserUpload[ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡] --> QueryExtract[æŸ¥è¯¢ä¾§ç‰¹å¾æå–]
    QueryExtract --> CascadeSearch["çº§è”æ£€ç´¢<br/>å…¨å›¾ANN â†’ å•†å®¶è¿‡æ»¤ â†’ Refineç²¾æ’"]
    CascadeSearch -->|"score â‰¥ 0.75<br/>é«˜ç½®ä¿¡åº¦"| DirectReturn[ç›´æ¥è¿”å›]
    CascadeSearch -->|"score < 0.75<br/>ä½ç½®ä¿¡åº¦"| MultiRecall[å¤šè·¯å¹¶è¡Œå¬å›] --> FusionSort[èåˆæ’åº] --> Return[è¿”å›]
  end
  subgraph QualityLoop["è´¨é‡é—­ç¯æµç¨‹"]
    direction LR
    SearchLog[æœç´¢æ—¥å¿—] --> RequestId["request_id å…³è”"]
    BizReport["ä¸šåŠ¡ç³»ç»Ÿè¡Œä¸ºä¸ŠæŠ¥"] --> RequestId
    RequestId --> MetricCalc[æŒ‡æ ‡è®¡ç®—] --> Monitor[è´¨é‡ç›‘æ§] --> Tuning[ç­–ç•¥è°ƒä¼˜] --> Verify[ä¸Šçº¿éªŒè¯]
  end
```

#### 3.1.2 æ£€ç´¢æµç¨‹è¯¦ç»†

```mermaid
sequenceDiagram
  participant Caller as ä¸šåŠ¡ç³»ç»Ÿ(è°ƒç”¨æ–¹)
  participant Search as å›¾æœç³»ç»Ÿ
  
  Caller->>Search: 1. POST /api/v1/image/search<br/>{query_image, merchant_scope?, top_k, time_range, data_scope, enable_fallback}
  
  Note over Search: 2. é™çº§çŠ¶æ€æ£€æŸ¥<br/>è‹¥é™çº§ â†’ è¦†ç›–å…¥å‚
  Note over Search: 3. data_scope åˆ†åŒºè·¯ç”±
  Note over Search: 4. æŸ¥è¯¢ä¾§ç‰¹å¾æå– [P95â‰ˆ20ms]
  Note over Search: 5. å…¨å›¾ANNæ£€ç´¢ [P99â‰ˆ40ms]<br/>HNSW+SQ8, top_k=2000
  Note over Search: 6. å•†å®¶Bitmapè¿‡æ»¤ [P99â‰¤3ms]
  Note over Search: 7. Refineç²¾æ’ [P99â‰¤5ms]
  
  alt score â‰¥ 0.75ï¼ˆå¿«è·¯å¾„, 75-85%è¯·æ±‚ï¼‰
    Note over Search: 8a. é«˜ç½®ä¿¡åº¦, ç›´æ¥è¿”å›
  else score < 0.75 ä¸” fallback=trueï¼ˆæ…¢è·¯å¾„ï¼‰
    Note over Search: 9. Lazyå­å›¾æå– (~15ms)
    Note over Search: 10. å¹¶è¡Œ: å­å›¾3è·¯ + æ ‡ç­¾è”åˆå¬å›
    Note over Search: 11. å»é‡ + èåˆæ’åº
  end
  
  Search-->>Caller: 12. è¿”å›å“åº” {request_id, results[], meta}
  Note over Caller: 13-14. ä¿å­˜ request_id, å±•ç¤ºç»“æœ
  Caller->>Search: 15. ä¸ŠæŠ¥è¡Œä¸ºäº‹ä»¶
```

#### 3.1.3 å†™å…¥æµç¨‹è¯¦ç»†

**update-imageï¼ˆç”Ÿäº§ä¸»é“¾è·¯ï¼Œå  95%+ å†™å…¥é‡ï¼‰**

```mermaid
sequenceDiagram
  participant Biz as å•†å®¶ç³»ç»Ÿ(è°ƒç”¨æ–¹)
  participant Sys as å›¾æœç³»ç»Ÿ
  participant Redis as Redis
  participant PG as PostgreSQL
  participant Milvus as Milvus
  participant Kafka as Kafka
  
  Biz->>Sys: 1. POST /api/v1/image/update<br/>{uri, merchant_id, category_l1}
  Sys->>Redis: 2. GET uri_map:{sha256(uri)}
  alt Rediså‘½ä¸­
    Redis-->>Sys: image_id (å·²å­˜åœ¨)
  else Redisæœªå‘½ä¸­
    Sys->>PG: SELECT image_id FROM uri_dedup
    alt PGå‘½ä¸­
      PG-->>Sys: image_id (å·²å­˜åœ¨)
      Sys->>Redis: SET å›å†™ç¼“å­˜
    else å…¨æœªå‘½ä¸­ (æ–°å›¾ç‰‡)
      Sys->>Redis: 3. SET uri_lock NX EX30
      Note over Sys: 4. æ–°å›¾ç‰‡åˆ›å»º<br/>image_id=sha256(uri)<br/>ä¸‹è½½â†’ç‰¹å¾æå–
      Note over Sys: 5. å¸¸é’æ ‡è®°æ¨å¯¼
      Sys->>Milvus: å†™å…¥å‘é‡+æ ‡é‡
      Sys->>PG: å†™å…¥URIæ˜ å°„
      Sys->>Redis: å†™å…¥ç¼“å­˜+é‡Šæ”¾é”
    end
  end
  Sys->>Kafka: 6. å‘é€å•†å®¶å…³è”äº‹ä»¶<br/>{image_id, merchant_id, ADD}
  Sys-->>Biz: 7. {status: accepted, image_id}
```

**update-videoï¼ˆè§†é¢‘å†™å…¥é“¾è·¯ï¼‰**ï¼šç³»ç»Ÿä¸‹è½½è§†é¢‘ â†’ FFmpeg æå–å‰5ç§’3ä¸ªå…³é”®å¸§ â†’ æ¯å¸§ç‹¬ç«‹èµ° update-image å†…éƒ¨æµç¨‹ã€‚

#### 3.1.4 è´¨é‡è¯„ä¼°é—­ç¯æµç¨‹

> [Mermaid æµç¨‹å›¾ï¼šæ•°æ®é‡‡é›†å±‚ â†’ æ•°æ®å…³è” â†’ åœ¨çº¿/ç¦»çº¿æŒ‡æ ‡è®¡ç®— â†’ è´¨é‡ç›‘æ§å¤§ç›˜ â†’ è¯Šæ–­è°ƒä¼˜ â†’ A/Bæµ‹è¯•éªŒè¯]

#### 3.1.5 æ•°æ®ç”Ÿå‘½å‘¨æœŸæµç¨‹

> [Mermaid æµç¨‹å›¾ï¼šå†™å…¥ â†’ æ»šåŠ¨åˆ†åŒº(çƒ­åŒºHNSW â†’ éçƒ­åŒºDiskANN â†’ TTLæ¸…ç†) + å¸¸é’åˆ†åŒº(æ°´ä½æ²»ç†)]

### 3.2 å¯¹è±¡å®ä½“

#### 3.2.1 é¢†åŸŸå¯¹è±¡æ¨¡å‹

```mermaid
classDiagram
  class Image {
    <<Aggregate Root>>
    +String image_id PK sha256(uri)
    +String uri UNIQUE â‰¤128
    +float[256] global_vec
    +String category_l1 å—æ§è¯è¡¨â‰¤20
    +String category_l2 å—æ§è¯è¡¨â‰¤300
    +String category_l3 å—æ§è¯è¡¨â‰¤8192
    +String[] tags 8-32ä¸ª è¯è¡¨â‰¤4096
    +String color
    +String material
    +String style
    +String pattern
    +String season
    +Boolean is_evergreen
    +Timestamp promoted_at
    +String ts_month
  }
  class SubImage {
    <<Value Object>>
    +String sub_id PK
    +String image_id FK
    +float[128] sub_vec
    +JSON bbox
    +Float confidence
    +Int region_idx
  }
  class Merchant {
    <<Entity>>
    +String merchant_id PK
    +UInt32 bitmap_index UNIQUE
    +Timestamp created_at
  }
  class ImageMerchantAssociation {
    <<Association>>
    +BigInt image_id PK
    +RoaringBitmap bitmap_data
    +Int merchant_count
    +Boolean is_evergreen
  }
  class SearchRequest {
    <<Value Object>>
    +String request_id
    +Binary query_image
    +String[] merchant_scope 500-3000
    +Int top_k é»˜è®¤100
    +Enum time_range 5m/18m
    +Enum data_scope evergreen/rolling/all
    +Boolean enable_fallback
  }
  class SearchResponse {
    <<Value Object>>
    +String request_id
    +SearchResult[] results
    +String confidence high/medium/low
    +String strategy
    +Boolean degraded
    +String data_scope
    +String search_scope_desc
  }
  class BehaviorEvent {
    <<Event>>
    +Enum event_type
    +String request_id
    +String image_id
    +Int position
    +Datetime timestamp
    +Int dwell_time_ms
  }
  class EvergreenConfig {
    <<Configuration>>
    +String category_l1 PK
    +Timestamp enabled_at
    +String operator
  }
  Image "1" --> "*" SubImage : åŒ…å«
  Image "1" --> "1" ImageMerchantAssociation : å…³è”
  Merchant "*" ..> "*" ImageMerchantAssociation : é€šè¿‡Bitmapå…³è”
  SearchRequest "1" --> "1" SearchResponse : äº§ç”Ÿ
  SearchResponse "1" --> "*" BehaviorEvent : è§¦å‘
  EvergreenConfig ..> Image : æ¨å¯¼ is_evergreen
```

#### 3.2.2 å¯¹è±¡å®ä½“è¯¦ç»†è¯´æ˜

**Imageï¼ˆå›¾ç‰‡ï¼‰â€” æ ¸å¿ƒèšåˆæ ¹**ï¼š
- image_id = sha256(uri) å‰ 16 å­—èŠ‚ hexï¼Œç¡®å®šæ€§ç”Ÿæˆï¼Œå¤©ç„¶å¹‚ç­‰
- æ ‡ç­¾å’Œç±»ç›®å¿…é¡»æ¥è‡ªå—æ§è¯è¡¨ï¼Œå†™å…¥æ—¶æ ¡éªŒ
- is_evergreen ç”± category_l1 æŸ¥è¯¢å¸¸é’ç±»ç›®é…ç½®è¡¨è‡ªåŠ¨æ¨å¯¼

**SubImageï¼ˆå­å›¾ï¼‰â€” Image çš„å€¼å¯¹è±¡**ï¼š
- å­å›¾é¢ç§¯ < åŸå›¾ 10% æ—¶è·³è¿‡
- æ¯å›¾æœ€å¤š 5 ä¸ªå­å›¾ï¼ˆæŒ‰ confidence é™åºå– Top5ï¼‰
- å†™å…¥ä¾§å…¨é‡æå–ï¼ŒæŸ¥è¯¢ä¾§ Lazy æŒ‰éœ€æå–

**Merchantï¼ˆå•†å®¶ï¼‰â€” ç‹¬ç«‹å®ä½“**ï¼š
- å•†å®¶ ID ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œç³»ç»Ÿå†…éƒ¨é€šè¿‡å­—å…¸ç¼–ç æ˜ å°„ä¸º uint32
- å½“å‰ 4000 ä¸‡å•†å®¶ï¼Œ10 å¹´å¢é•¿è‡³ 2 äº¿
- å­—å…¸ç¼–ç  TTL 18 ä¸ªæœˆ

**ImageMerchantAssociationï¼ˆå›¾ç‰‡-å•†å®¶å…³è”ï¼‰**ï¼š
- æ¯å›¾å…³è” 1-3000 ä¸ªå•†å®¶
- å†™å…¥é‡‡ç”¨ rb_or() åŸå­åˆå¹¶ï¼Œå¤©ç„¶å¹‚ç­‰

### 3.3 çŠ¶æ€æœº

#### 3.3.1 å›¾ç‰‡ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœº

```mermaid
stateDiagram-v2
  [*] --> CREATING : update-image (æ–°å›¾ç‰‡)
  CREATING --> ACTIVE : å†™å…¥å®Œæˆ
  state ACTIVE {
    [*] --> HOT
    HOT : çƒ­åŒº 0-5ä¸ªæœˆ (HNSW)
    NONHOT : éçƒ­åŒº 6-18ä¸ªæœˆ (DiskANN)
    HOT --> NONHOT : 5ä¸ªæœˆåè¿ç§»
  }
  ACTIVE --> EXPIRED : 18ä¸ªæœˆåˆ°æœŸ (éå¸¸é’)
  EXPIRED --> [*]
  CREATING --> EVERGREEN : is_evergreen=true ä¸”å†™å…¥å®Œæˆ
  state EVERGREEN {
    [*] --> GREEN
    GREEN : ç»¿åŒº æŒç»­ä¿ç•™
    GREEN --> YELLOW_RED : æ°´ä½ â‰¥ 2.5äº¿
    YELLOW_RED --> GREEN : æ¸…ç†åæ°´ä½å›è½
  }
  EVERGREEN --> EXPIRED : è¶…é¾„æ¸…ç† (æœ€ä½ä¿ç•™2å¹´)
```

#### 3.3.2 æœç´¢è¯·æ±‚å¤„ç†çŠ¶æ€æœº

> [çŠ¶æ€æœºï¼šRECEIVED â†’ é™çº§æ£€æŸ¥ â†’ EXTRACTING(P95â‰ˆ20ms) â†’ SEARCHING(P99â‰ˆ40ms) â†’ FILTERING(P99â‰¤3ms) â†’ REFINING(P99â‰¤5ms) â†’ ç½®ä¿¡åº¦åˆ¤å®š â†’ COMPLETED/FALLBACK]

#### 3.3.3 ç³»ç»Ÿé™çº§çŠ¶æ€æœº

```mermaid
stateDiagram-v2
  direction LR
  [*] --> S0_Normal
  S0_Normal --> S1_Pre : P99>450ms æŒç»­2m OR é”™è¯¯ç‡>0.05%
  S1_Pre --> S2_Hard : P99>800ms æŒç»­30s OR é”™è¯¯ç‡>1%
  S0_Normal --> S2_Hard : P99>800ms æŒç»­30s (ç›´é€š)
  S2_Hard --> S3_Rec : é©»ç•™10må AND P99ï¼œ500ms æŒç»­5m
  S1_Pre --> S3_Rec : é©»ç•™5må AND P99ï¼œ250ms æŒç»­10m
  S3_Rec --> S2_Hard : æŒ‡æ ‡æ¶åŒ– (å›é€€)
  S3_Rec --> S0_Normal : è§‚å¯ŸOK 10m + å†·å´15m
  S0_Normal --> S4_Manual : ManualOn
  S4_Manual --> S0_Normal : ManualOff
```

#### 3.3.4 å•†å®¶è¿‡æ»¤é™çº§çŠ¶æ€æœº

> [çŠ¶æ€æœºï¼šLevel 0 æœ¬åœ°RocksDB(P99â‰¤3ms) â†’ Level 1 è¿œç«¯PG(P99â‰ˆ10ms) â†’ Level 2 è·³è¿‡è¿‡æ»¤(filter_skipped=true)]

### 3.4 ä¸šåŠ¡é€»è¾‘

#### 3.4.1 æ ¸å¿ƒä¸šåŠ¡è§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| R1 URIå”¯ä¸€æ€§ | image_id = sha256(uri) å‰16å­—èŠ‚hexï¼Œç¡®å®šæ€§ç”Ÿæˆï¼Œå¤©ç„¶å¹‚ç­‰ |
| R2 å•†å®¶å…³è”è¿½åŠ è¯­ä¹‰ | update-image æ¯æ¬¡æºå¸¦ä¸€ä¸ª merchant_idï¼Œå•†å®¶åˆ—è¡¨é€æ­¥ç§¯ç´¯ |
| R3 å¹¶å‘å®‰å…¨ | åˆ†å¸ƒå¼é”(Redis SET NX EX30) + image_idç¡®å®šæ€§ + DB UNIQUEçº¦æŸ |
| R4 å¸¸é’æ¨å¯¼ | is_evergreen = (category_l1 âˆˆ å¸¸é’ç±»ç›®é…ç½®è¡¨)ï¼Œåªå¢ä¸å‡ |
| R5 ç±»ç›®å†²çªå¤„ç† | ç³»ç»ŸAIæå– â‰  ä¼ å…¥å€¼æ—¶ï¼Œä»¥ä¼ å…¥ä¸ºå‡†ï¼Œè®°å½•å‘Šè­¦æ—¥å¿— |
| R6 å¸¸é’æ± è§„æ¨¡æ²»ç† | ç»¿åŒº(<2.5äº¿)ä¸æ¸…ç† / é»„åŒº(2.5-3äº¿)å¹´é™é€’é™ / çº¢åŒº(â‰¥3äº¿)æ›´æ¿€è¿› |
| R7 ç½®ä¿¡åº¦åˆ†çº§ | HIGH(â‰¥0.75) / MEDIUM(0.50-0.75) / LOW(<0.50) |
| R8 å¿«è·¯å¾„vsæ…¢è·¯å¾„ | scoreâ‰¥0.75â†’å¿«è·¯å¾„(P95â‰ˆ43ms) / score<0.75 AND fallback=trueâ†’æ…¢è·¯å¾„(P95â‰ˆ77ms) |
| R9 é™çº§è¦†ç›– | é™çº§æ¨¡å¼ä¸‹ time_range=5m, fallback=falseï¼Œç³»ç»Ÿç¨³å®šæ€§ä¼˜å…ˆ |
| R10 data_scopeè·¯ç”± | evergreen/rolling/all ä¸‰ç§èŒƒå›´ Ã— time_range 5m/18m ç»„åˆ |
| R11 èåˆæ’åº | final_score = 0.4Ã—global_sim + 0.3Ã—max(sub_sims) + 0.2Ã—tag_overlap + 0.1Ã—cat_match |
| R12 ç›¸ä¼¼æ€§åˆ†å±‚ | L4å®Œå…¨ç›¸åŒ / L3åŒæ¬¾ / L2é«˜åº¦ç›¸ä¼¼ / L1ç±»ç›®ç›¸å…³ / L0ä¸ç›¸å…³ |
| R13 PMå¯é…ç½®èƒ½åŠ› | âœ…PMå¯é…(ç°åº¦éªŒè¯) / âš ï¸è”åˆéªŒè¯(A/B+æŠ€æœ¯è¯„å®¡) / âŒç³»ç»Ÿä¿æŠ¤(æ¶æ„è¯„å®¡ä¼š) |
| R14 æ¥å£å‘åå…¼å®¹ | æ–°å¢å­—æ®µé‡‡ç”¨å¯é€‰å‚æ•°(å¸¦é»˜è®¤å€¼)ï¼Œä¸ç ´åå·²æœ‰è°ƒç”¨æ–¹ |

**ç½®ä¿¡åº¦ç”¨æˆ·æç¤ºè¯­ä¹‰æ˜ å°„ï¼ˆv1.2 æ–°å¢ï¼‰**ï¼š

| ç½®ä¿¡åº¦ | å‰ç«¯æ¨èæç¤ºæ–‡æ¡ˆ |
|--------|----------------|
| HIGH | "æ‰¾åˆ°äº†ä¸å›¾ç‰‡é«˜åº¦ä¸€è‡´çš„å•†å“" |
| MEDIUM | "æœªæ‰¾åˆ°å®Œå…¨åŒæ¬¾ï¼Œä»¥ä¸‹æ˜¯ç›¸ä¼¼æ¬¾å¼æ¨è" |
| LOW | "æš‚æœªæ‰¾åˆ°é«˜åº¦ç›¸ä¼¼å•†å“ï¼Œä»¥ä¸‹æ˜¯åŒç±»æ¨è" |

**data_scope åˆ†åŒºè·¯ç”±ï¼ˆv4.0 ä¿®è®¢ï¼‰**ï¼š

| data_scope | time_range | æ£€ç´¢åˆ†åŒº |
|-----------|------------|---------|
| "evergreen" | (å¿½ç•¥) | ä»…å¸¸é’åˆ†åŒº |
| "rolling" | "5m" | è¿‘5ä¸ªæœˆçƒ­åŒº (ä¸å«å¸¸é’) |
| "rolling" | "18m" | è¿‘18ä¸ªæœˆæ»šåŠ¨ (çƒ­åŒº+éçƒ­åŒº) |
| "all"(é»˜è®¤) | "5m" | è¿‘5ä¸ªæœˆçƒ­åŒº + å¸¸é’ |
| "all"(é»˜è®¤) | "18m" | å…¨é‡æ»šåŠ¨ + å¸¸é’ |

#### 3.4.2 èåˆæ’åºé€»è¾‘

```
final_score = w1 Ã— global_sim      (æƒé‡ 0.4)
            + w2 Ã— max(sub_sims)   (æƒé‡ 0.3)
            + w3 Ã— tag_overlap     (æƒé‡ 0.2)
            + w4 Ã— cat_match       (æƒé‡ 0.1)
```

#### 3.4.3 ç›¸ä¼¼æ€§åˆ†å±‚æ ‡å‡†

| çº§åˆ« | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| L4 | å®Œå…¨ç›¸åŒ | åŒä¸€å›¾ç‰‡çš„ä¸åŒç‰ˆæœ¬ï¼ˆå°ºå¯¸/æ°´å°/è£å‰ªå·®å¼‚ï¼‰ |
| L3 | åŒæ¬¾å•†å“ | åŒä¸€ SPU çš„ä¸åŒè§’åº¦/åœºæ™¯/æ¨¡ç‰¹å›¾ |
| L2 | é«˜åº¦ç›¸ä¼¼ | ä¸åŒå•†å®¶çš„åŒæ¬¾å¼å•†å“ï¼ˆç»†èŠ‚å·®å¼‚ï¼‰ |
| L1 | ç±»ç›®ç›¸å…³ | åŒç±»ç›®ä½†æ¬¾å¼å·®å¼‚å¤§ |
| L0 | ä¸ç›¸å…³ | ä¸åŒç±»ç›®æˆ–æ— å…³å†…å®¹ |

> å¼ºç›¸å…³(Recallè®¡ç®—): L2åŠä»¥ä¸Š / ç›¸å…³(Precisionè®¡ç®—): L1åŠä»¥ä¸Š

### 3.5 å¼‚å¸¸å¤„ç†

#### 3.5.1 å¼‚å¸¸åˆ†ç±»

- **è¯·æ±‚å¼‚å¸¸**ï¼šå‚æ•°æ ¡éªŒå¤±è´¥ã€å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒã€merchant_scope è¶…é™ç­‰ â†’ HTTP 4xx
- **ç³»ç»Ÿå†…éƒ¨å¼‚å¸¸**ï¼šç‰¹å¾æå–å¤±è´¥ã€å‘é‡å†™å…¥å¤±è´¥ â†’ é‡è¯•/é™çº§/å¼‚æ­¥è¡¥å¿
- **åŸºç¡€è®¾æ–½å¼‚å¸¸**ï¼šRedis/PG/Milvus ä¸å¯ç”¨ â†’ å¤šçº§é™çº§é“¾è·¯
- **ä¸šåŠ¡å¼‚å¸¸**ï¼šå•†å®¶æœªæ³¨å†Œã€ç±»ç›®è¯è¡¨å¤–å€¼ â†’ HTTP 400 + æ˜ç¡®é”™è¯¯ç 

#### 3.5.2-3.5.4 å†™å…¥/æ£€ç´¢/è§†é¢‘å¼‚å¸¸å¤„ç†

> [è¯¦è§åŸæ–‡ flowchart å’Œè¡¨æ ¼]

### 3.6 æ•°æ®å®ä½“

#### 3.6.1 æ•°æ®å®ä½“å…³ç³»å›¾

```mermaid
erDiagram
  global_images ||--o{ sub_images : "1:N åŒ…å«"
  global_images ||--|| image_merchant_bitmaps : "1:1 å…³è”"
  merchant_id_mapping }o--o{ image_merchant_bitmaps : "N:N via Bitmap"
  global_images ||--o| uri_cache : "1:0..1 ç¼“å­˜"
  evergreen_categories ||--o{ global_images : "æ¨å¯¼ is_evergreen"
  search_logs ||--o{ behavior_events : "request_id å…³è”"
```

#### 3.6.2 å­˜å‚¨å¼•æ“åˆ†å·¥

| å¼•æ“ | è§’è‰² | å…³é”®æ•°æ® |
|------|------|---------|
| **Milvus** | å‘é‡æ£€ç´¢ + æ ‡é‡è¿‡æ»¤ | å‘é‡(HNSW/DiskANN) + ç±»ç›®/å±æ€§/æ ‡ç­¾(INVERTED index) |
| **PostgreSQL** | å…ƒæ•°æ® + Bitmap | URIæ˜ å°„ã€å•†å®¶å­—å…¸ç¼–ç ã€å•†å®¶Bitmap |
| **Redis** | ç¼“å­˜ | URIæŸ¥é‡ç¼“å­˜(90d)ã€å­—å…¸ç¼–ç ç¼“å­˜ |
| **RocksDB** | æœ¬åœ° Bitmap ç¼“å­˜ | æœç´¢èŠ‚ç‚¹æœ¬åœ° Bitmap å‰¯æœ¬ï¼ˆCDCåŒæ­¥ï¼‰ |

#### 3.6.3 æ•°æ®åˆ†åŒºç­–ç•¥

> **v4.0 é‡æ„**ï¼šå¯¹é½æŠ€æœ¯æ¶æ„ v1.2 ä¸¤åŒºåˆ†åŒºæ¨¡å‹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Milvus åˆ†åŒºå¸ƒå±€ (v4.0)                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ çƒ­åŒº (HNSW) â€” æœ€è¿‘ 5 ä¸ªæœˆæ»šåŠ¨æ•°æ®                        â”‚    â”‚
â”‚ â”‚ ~7.5 äº¿å‘é‡ | å†…å­˜å¸¸é©» | 99.99% SLA                      â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ éçƒ­åŒº (DiskANN) â€” ç¬¬ 6-18 æœˆæ»šåŠ¨ + å¸¸é’                 â”‚    â”‚
â”‚ â”‚ ~22 äº¿å‘é‡ (æ»šåŠ¨ 19.5 äº¿ + å¸¸é’ â‰¤3 äº¿)                   â”‚    â”‚
â”‚ â”‚ NVMe ç£ç›˜æ£€ç´¢ | å¯é™çº§è·³è¿‡                                â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚ æ€»è®¡: æ»šåŠ¨ ~26.5 äº¿ + å¸¸é’ â‰¤3 äº¿ = ~29.5 äº¿                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.7 æ•°æ®æµå›¾

> [DFD Level 0 / Level 1 / Level 2 å†™å…¥æ•°æ®æµ / æ£€ç´¢æ•°æ®æµ / è´¨é‡è¯„ä¼°æ•°æ®æµ â€” è¯¦è§åŸæ–‡ Mermaid æµç¨‹å›¾]

---

## å››ã€åŠŸèƒ½éœ€æ±‚

### 4.1 ç›¸ä¼¼åº¦æ£€ç´¢

> [è¡¨æ ¼ï¼šæ£€ç´¢åŠŸèƒ½è¯¦ç»†è§„æ ¼]

### 4.2 å•†å®¶èŒƒå›´è¿‡æ»¤

**è¿‡æ»¤è¯­ä¹‰**ï¼š`image.merchant_ids âˆ© merchant_scope â‰  âˆ…`

**merchant_scope æ¥æºè¯´æ˜ï¼ˆv4.0.1 æ–°å¢ï¼‰**ï¼šæŸ¥è¯¢æ—¶ä¼ å…¥çš„ merchant_scopeï¼ˆ0-3000 ä¸ªå•†å®¶ IDï¼‰ç”±è°ƒç”¨æ–¹è‡ªè¡Œç»´æŠ¤ï¼Œå›¾æœç³»ç»Ÿä¸è´Ÿè´£é›†åˆçš„æ„å»ºä¸æ›´æ–°ã€‚è¶…è¿‡ 3000 ä¸ªå•†å®¶çš„æŸ¥è¯¢å°†è¢«æ‹’ç»ï¼ˆHTTP 400ï¼‰ã€‚

### 4.3 æ—¶é—´èŒƒå›´ç­–ç•¥

> [è¡¨æ ¼ï¼š5m/18m æ—¶é—´èŒƒå›´ç­–ç•¥è¯¦ç»†è¯´æ˜]

> å¸¸é’èŠ‚ç‚¹åœ¨ data_scope=all æ—¶å§‹ç»ˆå‚ä¸æŸ¥è¯¢ï¼›data_scope=rolling æ—¶ä¸å‚ä¸ã€‚

### 4.4 å¤šç²’åº¦æ£€ç´¢ï¼ˆé•¿å°¾å…œåº•ï¼‰

> **v4.0 é‡æ„**ï¼šä»å•è·¯ ANN + fallback æ ‡ç­¾æ¨¡å¼æ¼”è¿›ä¸ºä¸¤åŒºçº§è” + å…¨é‡æ ‡ç­¾åŒè·¯å¬å›ã€‚

**æ£€ç´¢ç­–ç•¥çº§è”æµç¨‹ï¼ˆv4.0ï¼‰**ï¼š

```mermaid
flowchart TD
  A[ç”¨æˆ·ä¸Šä¼ æŸ¥è¯¢å›¾ç‰‡] --> B["Stage 0: æŸ¥è¯¢ä¾§ç‰¹å¾æå–\nå…¨å›¾å‘é‡ + æ ‡ç­¾"]
  B --> C["Stage 1: çƒ­åŒº ANN ç²—ç­›\nHNSW top_k=2000"]
  C --> C1["Stage 1.5: å…¨é‡æ ‡ç­¾å¬å› (v4.0)\nINVERTED top_k=500\nä¸ ANN åˆå¹¶å»é‡"]
  C1 --> D["Stage 2: å•†å®¶è¿‡æ»¤\nbitmap-filter 2500 å€™é€‰"]
  D --> E["Stage 3: Refine ç²¾æ’\nfloat32 é‡æ’ 2000 å€™é€‰"]
  E --> F{"Top1 score â‰¥ 0.80?\n(å¿«è·¯å¾„åˆ¤å®š)"}
  F -->|"æ˜¯ (~80%)\nP99 â‰¤ 240ms"| G1[confidence = high]
  G1 --> H[è¿”å›ç»“æœ]
  F -->|"å¦ (~20%)\nçº§è”ç©¿é€"| Cascade["Stage 1b: éçƒ­åŒº ANN\nDiskANN top_k=2000"]
  Cascade --> Merge["åˆå¹¶çƒ­åŒº+éçƒ­åŒº+æ ‡ç­¾\nâ†’ Refine â†’ Bitmap"]
  Merge --> F2{"Top1 score â‰¥ 0.75?"}
  F2 -->|"æ˜¯"| G2[confidence = high/medium]
  G2 --> H
  F2 -->|"å¦, â‰¥ 0.50"| J[confidence = medium]
  J --> H
  F2 -->|"å¦, < 0.50\n(æå°‘æ•°)"| K[è§¦å‘å­å›¾ Fallback]
  K --> L["Stage 0b: å­å›¾ç‰¹å¾å»¶è¿Ÿæå–\nLazy æ¨¡å¼"]
  L --> M1[å­å›¾å¤šå‘é‡ ANN å¹¶è¡Œæ£€ç´¢]
  M1 --> N["Stage 7: èåˆæ’åº + å»é‡"]
  N --> O[confidence = low]
  O --> H
```

### 4.5 æ•°æ®èŒƒå›´æŸ¥è¯¢ï¼ˆv3.4 æ–°å¢ï¼‰

**data_scope ä¸ time_range ç»„åˆå…³ç³»**ï¼š

| data_scope | time_range | å®é™…æ£€ç´¢åˆ†åŒº | å…¸å‹åœºæ™¯ |
|-----------|------------|-------------|---------|
| "all"(é»˜è®¤) | "18m" | å…¨é‡æ»šåŠ¨ + å¸¸é’ | å…¨é‡æœç´¢ |
| "all"(é»˜è®¤) | "5m" | è¿‘5æœˆçƒ­åŒº + å¸¸é’ | æ—¥å¸¸å¿«æœ |
| "rolling" | "18m" | è¿‘18æœˆæ»šåŠ¨ (ä¸å«å¸¸é’) | å¿«å˜è¡Œä¸š |
| "evergreen" | (å¿½ç•¥) | ä»…å¸¸é’åˆ†åŒº | æ…¢å˜è¡Œä¸š |

---

## äº”ã€æ€§èƒ½ä¸è´¨é‡è¦æ±‚

### 5.1 åœ¨çº¿æŸ¥è¯¢æ€§èƒ½ï¼ˆSLOï¼‰

> **v4.0 é‡æ„**ï¼šä»å•ä¸€ P99 <300ms æ¼”è¿›ä¸º**åŒè·¯å¾„å»¶è¿Ÿæ¨¡å‹**ã€‚

| è·¯å¾„ | è¯·æ±‚æ¯”ä¾‹ | P99 ç›®æ ‡ | åœºæ™¯ |
|------|---------|---------|------|
| **å¿«è·¯å¾„** | ~80% | **â‰¤ 240ms** | çƒ­åŒº HNSW ANN + å…¨é‡æ ‡ç­¾å¬å› â†’ å•†å®¶è¿‡æ»¤ â†’ Refine, Top1 score â‰¥ 0.80 |
| **çº§è”è·¯å¾„** | ~20% | **â‰¤ 400ms** | çƒ­åŒºæœªå‘½ä¸­ â†’ ç©¿é€éçƒ­åŒº DiskANN â†’ åˆå¹¶ â†’ è¿‡æ»¤ â†’ Refine |

**çº§è”ç©¿é€ç‡å£°æ˜ï¼ˆv4.0.1 æ–°å¢ï¼‰**ï¼š~20% ä¸ºè®¾è®¡ç›®æ ‡ï¼Œé SLA æ‰¿è¯ºã€‚ç©¿é€ç‡æŒ‡æ ‡ cascade_penetration_ratio æŒ‰å°æ—¶ç»Ÿè®¡ã€‚

**åˆä½œæ–¹è¶…æ—¶é…ç½®è¦æ±‚ï¼ˆv4.0.1 å¼ºè°ƒï¼‰**ï¼šæ‰€æœ‰è°ƒç”¨æ–¹å¿…é¡»å°† timeout è®¾ç½®ä¸º **â‰¥500ms**ã€‚

### 5.2 å­ç³»ç»Ÿå»¶è¿Ÿé¢„ç®—

**å¿«è·¯å¾„é¢„ç®—ï¼ˆ~80% è¯·æ±‚ï¼Œçƒ­åŒºå‘½ä¸­ï¼‰**ï¼š

| é˜¶æ®µ | å†…å®¹ | é¢„ç®— |
|------|------|------|
| Stage 0 | æŸ¥è¯¢ä¾§ç‰¹å¾æå– (TensorRT FP16) | â‰¤ 30ms |
| Stage 1 | çƒ­åŒº ANN (HNSW top_k=2000) | â‰¤ 40ms |
| Stage 1.5 | å…¨é‡æ ‡ç­¾å¬å› (INVERTED top_k=500) | â‰¤ 10ms |
| Stage 2 | å•†å®¶è¿‡æ»¤ (bitmap-filter gRPC) | â‰¤ 8ms |
| Stage 3 | ç²¾æ’ Refine (float32 é‡æ’ 2000 å€™é€‰) | â‰¤ 7ms |
| å…¶ä»– | ç½‘ç»œ/åºåˆ—åŒ–/é™çº§åˆ¤æ–­ | â‰¤ 15ms |
| å¯Œä½™ | å®‰å…¨ä½™é‡ | ~20ms |
| **å¿«è·¯å¾„æ€»è®¡** | | **â‰¤ 240ms** |

**æ ‡ç­¾å¬å›æˆªæ–­ä¿æŠ¤ï¼ˆv4.0.1 æ–°å¢ï¼‰**ï¼šä»…å– IDF æœ€é«˜çš„ Top-5 æ ‡ç­¾å‚ä¸å¬å›ï¼›Stage 1.5 è®¾ç½®ç¡¬è¶…æ—¶ 10msï¼›tag_recall_timeout_ratio é¢„è­¦ >5%ï¼Œå‘Šè­¦ >10%ã€‚

**çº§è”è·¯å¾„è¿½åŠ é¢„ç®—ï¼ˆ~20% è¯·æ±‚ï¼‰**ï¼š

| é˜¶æ®µ | å†…å®¹ | é¢„ç®— |
|------|------|------|
| Stage 1b | éçƒ­åŒº DiskANN ANN | â‰¤ 120ms |
| åˆå¹¶/Refine | åˆå¹¶çƒ­åŒº+éçƒ­åŒºå€™é€‰ | â‰¤ 25ms |
| å…¶ä»– | å¯Œä½™ | ~15ms |
| **çº§è”è·¯å¾„æ€»è®¡** | | **â‰¤ 400ms** |

**v4.0 vs v3.9 å˜æ›´è¯´æ˜**ï¼š(1) å…¨é‡æ ‡ç­¾å¬å›ä» fallback ä¸“ç”¨æå‡ä¸ºæ¯æ¬¡å¿…æ‰§è¡Œ(Stage 1.5)ï¼›(2) Refine å€™é€‰æ± ä» 500â†’2000ï¼›(3) å•†å®¶è¿‡æ»¤ Batch ä» 2000â†’2500ï¼›(4) å¿«è·¯å¾„æ€»é¢„ç®—ä» â‰¤108msâ†’â‰¤240msï¼ˆef_search=192 æ›´ç²¾ç¡®ä½†æ›´æ…¢ï¼‰ï¼ŒRecall ä» 95%â†’98.5%ã€‚

#### 5.2.1 å­å›¾ Fallback å»¶è¿Ÿé¢„ç®—

> å­å›¾ Fallback æ€»å»¶è¿Ÿ P99 â‰¤ çº§è”è·¯å¾„ 400ms + 45ms = **â‰¤ 445ms**ã€‚ä»…æå°‘æ•°è¯·æ±‚è§¦å‘ã€‚

### 5.3 å†™å…¥æ€§èƒ½ä¸å¯è§æ€§

> **v4.0 é‡æ„**ï¼šå†™å…¥å¯è§æ€§ **3Ã— å‹ç¼©**ã€‚

| å†™å…¥è·¯å¾„ | è¯´æ˜ | P95 | P99 | v3.9â†’v4.0 å˜åŒ– |
|---------|------|-----|-----|---------------|
| è·¯å¾„1 æ‰¹é‡å†™å…¥(image/index) | ä»æ¥å£è¿”å›åˆ°æ£€ç´¢å‘½ä¸­ | â‰¤ 5s | â‰¤ 10s | 15sâ†’5s (3Ã—) |
| è·¯å¾„2 update-image(å›¾ç‰‡å·²å­˜åœ¨) | ä»æ¥å£è¿”å›åˆ°å•†å®¶å…³è”å¯è§ | â‰¤ 10s | â‰¤ 20s | 30sâ†’10s (3Ã—) |
| è·¯å¾„3 update-image(æ–°å›¾ç‰‡) | ä»æ¥å£è¿”å›åˆ°å…¨éƒ¨å¯è§ | â‰¤ 15s | â‰¤ 30s | 45sâ†’15s (3Ã—) |

**å¯è§æ€§ SLA é€‚ç”¨èŒƒå›´å£°æ˜ï¼ˆv4.0.1 æ–°å¢ï¼‰**ï¼šä¸Šè¿°ç›®æ ‡ä»¥ç”Ÿäº§ä¸»é“¾è·¯ä¸ºç¬¬ä¸€ä¼˜å…ˆçº§ã€‚è¿ç§»/å¼‚å¸¸è¡¥å¿/æœˆåº¦ç»´æŠ¤é“¾è·¯å…è®¸é€€åŒ–ï¼Œä¸è®¡å…¥æ ¸å¿ƒå¯è§æ€§ SLAã€‚

### 5.4 å¬å›è´¨é‡

> **v4.0 æå‡**ï¼šå•è·¯ Recall@100 ä» â‰¥95% æå‡è‡³ **â‰¥98%**ï¼ˆçƒ­åŒº 98.5% / éçƒ­åŒº 98%ï¼‰ï¼›ç³»ç»Ÿçº§ç­‰æ•ˆ Recall â‰ˆ99-99.5%ã€‚

**ç›¸å…³æ€§å®šä¹‰æ‰€æœ‰æƒå£°æ˜ï¼ˆv3.8 æ–°å¢ï¼‰**ï¼šäº§å“+ç®—æ³•å›¢é˜Ÿè”åˆç»´æŠ¤ã€‚

---

## å…­ã€é«˜å¯ç”¨ä¸ SLA è®¾è®¡

### 6.1 å¯ç”¨æ€§ç›®æ ‡ï¼ˆè‡ªç„¶æœˆï¼‰

| åŠŸèƒ½å±‚ | SLA | æœˆåœæœºä¸Šé™ | è¦†ç›–èŒƒå›´ |
|--------|-----|----------|---------|
| **æ ¸å¿ƒåŠŸèƒ½** | **99.99%** | â‰¤ 4.0-4.5 åˆ†é’Ÿ | è¿‘5ä¸ªæœˆçƒ­åŒº(~7.5äº¿) + å¸¸é’(â‰¤3äº¿) |
| **å®Œæ•´åŠŸèƒ½** | **99.5%** | â‰¤ 3.4-3.9 å°æ—¶ | å…¨é‡18ä¸ªæœˆ(~26.5äº¿) + å¸¸é’(â‰¤3äº¿) |

> **v4.0 å˜æ›´**ï¼šæ ¸å¿ƒåŠŸèƒ½ SLA è¦†ç›–èŒƒå›´ä»è¿‘ 3 æœˆæ‰©å¤§è‡³**è¿‘ 5 æœˆ**ã€‚

### 6.2 SLA è®¾è®¡åŸåˆ™

- é”™è¯¯é¢„ç®—ä¼˜å…ˆäºåŠŸèƒ½å®Œæ•´æ€§
- çƒ­åŒº(HNSW) + å¸¸é’ç¨³å®šæ€§ä¼˜å…ˆäºéçƒ­åŒº(DiskANN)å¯ç”¨æ€§
- è‡ªåŠ¨é™çº§ä¼˜å…ˆäºäººå·¥å¹²é¢„

### 6.3 é™çº§è§¦å‘ç­–ç•¥

| çº§åˆ« | è§¦å‘æ¡ä»¶ | æŒç»­æ—¶é—´ |
|------|---------|---------|
| **é¢„é™çº§** | P99 > 450ms OR é”™è¯¯ç‡ > 0.05% | â‰¥ 2 åˆ†é’Ÿ |
| **å¼ºé™çº§** | P99 > 800ms OR é”™è¯¯ç‡ > 1% OR AZä¸å¥åº· | â‰¥ 30 ç§’ |

### 6.4 é™çº§è¡Œä¸º

é™çº§æ—¶ï¼šå¼ºåˆ¶å›é€€è‡³çƒ­åŒº(è¿‘5æœˆ) + å¸¸é’ï¼›å›ºå®š Top100ï¼›è·³è¿‡å­å›¾ fallbackï¼ˆå…¨é‡æ ‡ç­¾å¬å›ä»ä¿ç•™ï¼‰ï¼›è¿”å› meta.degraded = trueã€‚

### 6.5-6.7 éçƒ­åŒºæ•…éšœå¤„ç† / å•†å®¶è¿‡æ»¤é™çº§ / ç›‘æ§å‘Šè­¦

> [è¯¦è§åŸæ–‡è¡¨æ ¼å’ŒçŠ¶æ€æœº]

---

## ä¸ƒã€æ¥å£éœ€æ±‚

**å‘åå…¼å®¹æ‰¿è¯ºï¼ˆv3.7 æ–°å¢ï¼‰**ã€‚

**âš ï¸ è°ƒç”¨æ–¹è¶…æ—¶é…ç½®è¦æ±‚ï¼ˆv4.0.1 æ–°å¢ï¼‰**ï¼šæ‰€æœ‰è°ƒç”¨æ–¹å¿…é¡»å°† HTTP è¶…æ—¶è®¾ç½®ä¸º â‰¥500msã€‚

### 7.1 æ£€ç´¢æ¥å£

`POST /api/v1/image/search`

**è¯·æ±‚å‚æ•°**ï¼šquery_image(å¿…å¡«)ã€merchant_scope(å¯é€‰,0-3000)ã€top_k(é»˜è®¤100,ä¸Šé™200)ã€time_range(5m/18m)ã€data_scope(evergreen/rolling/all)ã€enable_fallback(é»˜è®¤true)

**å“åº”**ï¼šrequest_idã€results[]ï¼ˆimage_id, score, product_id, tags, category_l1/l2/l3, merchant_idsï¼‰ã€metaï¼ˆconfidence, strategy, degraded, data_scope, search_scope_desc, filter_skipped, is_evergreenï¼‰

### 7.2 å†™å…¥æ¥å£

#### 7.2.1 update-imageï¼ˆç”Ÿäº§ä¸»é“¾è·¯ï¼‰

`POST /api/v1/image/update` â€” å‚æ•°ï¼šuri(å¿…å¡«,â‰¤128)ã€merchant_id(å¿…å¡«)ã€category_l1(å¿…å¡«)ã€product_id(å¯é€‰)

#### 7.2.2 æ‰¹é‡å†™å…¥æ¥å£ï¼ˆimage/indexï¼‰

> ç”¨äºæ•°æ®è¿ç§»ã€ç®¡ç†åå°ç­‰åœºæ™¯

#### 7.2.3 å•†å®¶å…³è”å¢é‡æ›´æ–°

> [è¯¦è§åŸæ–‡]

#### 7.2.4 è§†é¢‘å†™å…¥æ¥å£ï¼ˆupdate-video, v3.4 æ–°å¢ï¼‰

`POST /api/v1/video/update` â€” å‚æ•°ï¼švideo_uri(å¿…å¡«)ã€merchant_id(å¿…å¡«)ã€category_l1(å¿…å¡«)

---

## å…«ã€æ•°æ®è´¨é‡è¦æ±‚

### 8.1 æ¯å›¾å¿…å¡«æ•°æ®æ ¡éªŒ

> [è¯¦è§åŸæ–‡è¡¨æ ¼ï¼šæ‰¹é‡å†™å…¥æ ¡éªŒ / ç”Ÿäº§å†™å…¥æ ¡éªŒ / è§†é¢‘å†™å…¥æ ¡éªŒ]

### 8.2 å›¾ç‰‡ç‰¹å¾æå–

> å†™å…¥ä¾§ï¼ˆç¦»çº¿/å¼‚æ­¥ï¼‰+ æŸ¥è¯¢ä¾§ï¼ˆåœ¨çº¿ P99 â‰¤ 30msï¼‰

### 8.3 å­å›¾æå–è§„åˆ™

> é¢ç§¯ â‰¥ 10% / æ¯å›¾æœ€å¤š5ä¸ª / confidenceé™åº

### 8.4 æ ‡ç­¾è´¨é‡

> åˆ†ç±»è¯è¡¨ â‰¤8192 / æ ‡ç­¾è¯è¡¨ â‰¤4096 / æ¯å›¾åˆè®¡ä¸Šé™32ä¸ª / å†…éƒ¨æ•´æ•°ç¼–ç å­˜å‚¨

### 8.5 å•†å®¶å…³è”æ•°æ®è´¨é‡

> [è¯¦è§åŸæ–‡è¡¨æ ¼]

### 8.6 è´¨é‡é—­ç¯

**è¡Œä¸ºä¸ŠæŠ¥è¾¹ç•Œå£°æ˜ï¼ˆv3.8 æ–°å¢ï¼‰**ï¼šè¡Œä¸ºä¸ŠæŠ¥ä¸ºå¯é€‰å¢å¼ºèƒ½åŠ›ï¼Œä¸å±äºæ ¸å¿ƒåŠŸèƒ½ã€‚

**ä¸ŠæŠ¥å®Œæ•´æ€§å…è´£æ¡æ¬¾ï¼ˆv4.0.1 æ–°å¢ï¼‰**ï¼šä¸ŠæŠ¥è¦†ç›–ç‡ <80% æ—¶ä¸šåŠ¡æŒ‡æ ‡ä»…ä½œè¶‹åŠ¿å‚è€ƒï¼ŒGo/No-Go æ­¢æŸçº¿ä¸å¯ç”¨ã€‚

### 8.7 äº§å“å¯é…ç½®èƒ½åŠ›è¾¹ç•Œï¼ˆv3.7 æ–°å¢ï¼‰

| åˆ†ç±» | é¡¹ç›® |
|------|------|
| âœ… PM å¯é…ç½® | å¸¸é’ç±»ç›®åˆ—è¡¨ã€data_scopeé»˜è®¤å€¼ã€confidenceæç¤ºæ–‡æ¡ˆã€search_scope_descæ¨¡æ¿ |
| âš ï¸ è”åˆéªŒè¯ | ç›¸ä¼¼åº¦é˜ˆå€¼(å½“å‰0.75)ã€Top-Ké»˜è®¤å€¼(å½“å‰100) |
| âŒ ç³»ç»Ÿä¿æŠ¤ | fallbackå¼€å…³ã€Top-Kç¡¬ä¸Šé™(200)ã€é™çº§é˜ˆå€¼ã€æ—¶é—´åˆ†å±‚è¾¹ç•Œã€å¸¸é’æ± ç¡¬ä¸Šé™(3äº¿) |

**åæ»¥ç”¨ä½¿ç”¨çº¦æŸ**ï¼š

> [è¡¨æ ¼ï¼šç¦æ­¢çš„ä½¿ç”¨æ–¹å¼]

**è°ƒç”¨æ–¹ä¾èµ–çº§åˆ«å®šä¹‰**ï¼š

> [è¡¨æ ¼ï¼šL0 / L1 / L2 ä¸‰çº§ä¾èµ–]

---

## ä¹ã€æˆæœ¬çº¦æŸä¸æ¼”è¿›åŸåˆ™

### 9.1 è®¾è®¡åŸåˆ™

æœ€ç®€å¯è¡Œæ–¹æ¡ˆå…ˆä¸Šçº¿ï¼Œç›‘æ§é©±åŠ¨æ¼”è¿›ï¼Œä¸è¿‡åº¦è®¾è®¡ã€‚

### 9.2 åˆ†é˜¶æ®µæ¼”è¿›é¢„æœŸ

> **v4.0 å˜æ›´**ï¼šä»å•ä¸€äº‘éƒ¨ç½²æ–¹æ¡ˆæ¼”è¿›ä¸ºåŒéƒ¨ç½²æ–¹æ¡ˆã€‚

> [è¡¨æ ¼ï¼šå½“å‰åŸºçº¿æˆæœ¬â€”â€”äº‘æ–¹æ¡ˆ / è‡ªå»º IDC æ–¹æ¡ˆå¯¹æ¯”]

---

## åã€éªŒæ”¶æ ‡å‡†

### 10.0 éªŒæ”¶æ€»åˆ™ï¼ˆv3.7 æ–°å¢ï¼‰

**P0 å¿…æµ‹ä¸»å¹²è·¯å¾„**ï¼šdata_scope=all + time_range=18m + å¤šå•†å®¶è¿‡æ»¤ + update-image ä¸¤è·¯å¾„ + å¿«è·¯å¾„ç«¯åˆ°ç«¯ + åŒè·¯å¾„ P99 è¾¾æ ‡

**P1 æŠ½æ ·è¦†ç›–è·¯å¾„**ï¼šdata_scope ç‹¬ç«‹æŸ¥è¯¢ / å­å›¾ fallback / éçƒ­åŒºé™çº§ / å•†å®¶è¿‡æ»¤é™çº§é“¾è·¯ / update-video / confidenceæ ‡è®°

**P2 æç«¯éªŒè¯è·¯å¾„**ï¼šå•å›¾3000å•†å®¶ / å•å›¾1å•†å®¶ / URIä¸Šé™ / æ ‡ç­¾ä¸Šä¸‹é™ / å¸¸é’æ± æ¸…ç†è¡Œä¸º

### 10.1-10.4 åŠŸèƒ½/æ€§èƒ½/æ•°æ®è§„æ¨¡/é«˜å¯ç”¨éªŒæ”¶

> [è¯¦è§åŸæ–‡è¡¨æ ¼]

### 10.5 é˜¶æ®µæ€§æ­¢æŸçº¿ï¼ˆGo / No-Go, v3.7 æ–°å¢ï¼‰

```mermaid
flowchart LR
  A["MVP é˜¶æ®µ\nä¸Šçº¿å3ä¸ªæœˆ"] --> B{"CTR â‰¥ 5%\nAND\nRecall@20 â‰¥ 75%?"}
  B -->|æ˜¯| C["Go â†’ è¿›å…¥æ­£å¼è¿è¥"]
  B -->|å¦| D["No-Go â†’ æš‚åœæ‰©å±•"]
  C --> E["æ­£å¼è¿è¥\nä¸Šçº¿å6-9ä¸ªæœˆ"]
  E --> F{"æœç´¢â†’ä¸‹å•ç‡ â‰¥ 0.5%?"}
  F -->|æ˜¯| G["Go â†’ è¿½åŠ èµ„æº"]
  F -->|å¦| H["No-Go â†’ ä¸å†è¿½åŠ èµ„æº"]
  G --> I["æˆç†Ÿé˜¶æ®µ\nä¸Šçº¿å12+ä¸ªæœˆ"]
  I --> J{"å›¾æœGMVå æ¯” â‰¥ 5%?"}
  J -->|æ˜¯| K["å‡çº§ä¸ºå¹³å°çº§èƒ½åŠ›"]
  J -->|å¦| L["ç»´æŒç°æœ‰æŠ•å…¥"]
```

---

## åä¸€ã€ä¸‰è§†è§’éªŒæ”¶ Checklist

### A. ç ”å‘è§†è§’ï¼ˆEngineeringï¼‰

- [ ] çƒ­åŒº(HNSW)/éçƒ­åŒº(DiskANN)/å¸¸é’åˆ†åŒºé€»è¾‘éš”ç¦»æ¸…æ™°
- [ ] data_scope å‚æ•°æ­£ç¡®è·¯ç”±æŸ¥è¯¢åˆ†åŒº
- [ ] ç³»ç»Ÿé™çº§å¯è¦†ç›–ç”¨æˆ·å…¥å‚ï¼Œæ‰€æœ‰é™çº§è·¯å¾„å¯è‡ªåŠ¨è§¦å‘
- [ ] å•†å®¶è¿‡æ»¤å­ç³»ç»Ÿå…·å¤‡ç‹¬ç«‹é™çº§é“¾è·¯
- [ ] å¿«è·¯å¾„ P99 â‰¤ 240ms / çº§è”è·¯å¾„ P99 â‰¤ 400msï¼ˆå«500-3000å•†å®¶è¿‡æ»¤ï¼‰
- [ ] æŸ¥è¯¢ä¾§ç‰¹å¾æå– P99 â‰¤ 30ms
- [ ] æ¨ç†å¼•æ“ TensorRT/ONNX Runtime FP16ï¼Œå•æ¬¡backbone â‰¤ 15ms
- [ ] Lazyæ¨¡å¼ï¼šå…¨å›¾ Top1 score â‰¥ 0.80 æ—¶æ—  YOLOv8 è°ƒç”¨
- [ ] Refine çƒ­åŒº P99 â‰¤ 7msï¼ˆå€™é€‰æ± 2000ï¼‰
- [ ] å…¨é‡æ ‡ç­¾å¬å›æ¯æ¬¡å¿…æ‰§è¡Œï¼ˆStage 1.5ï¼‰
- [ ] Fallback å¤šè·¯å¬å›å¹¶è¡Œæ‰§è¡Œ
- [ ] meta.search_scope_desc / æ¥å£å‘åå…¼å®¹

### B. æµ‹è¯•è§†è§’ï¼ˆQAï¼‰

- [ ] å•/å¤šå•†å®¶è¿‡æ»¤æ­£ç¡®ï¼ˆå­—ç¬¦ä¸²IDï¼Œ500/1000/3000ä¸‰æ¡£ï¼‰
- [ ] 5m/18mç­–ç•¥æ­£ç¡®ï¼Œå¸¸é’å§‹ç»ˆå‚ä¸
- [ ] update-image ä¸¤è·¯å¾„ï¼ˆå·²æœ‰å›¾/æ–°å›¾ï¼‰
- [ ] update-video æ­£å¸¸/å¼‚å¸¸åœºæ™¯
- [ ] confidence ä¸‰æ¡£æ ‡è®° + ç”¨æˆ·æç¤ºè¯­ä¹‰
- [ ] é™çº§æ³¨å…¥â†’è‡ªåŠ¨é™çº§â†’æ¢å¤åè‡ªåŠ¨å›åˆ‡
- [ ] å‹æµ‹ï¼šå¿«è·¯å¾„ P99 â‰¤ 240ms / çº§è”è·¯å¾„ P99 â‰¤ 400ms

### C. è¿ç»´/SRE è§†è§’

- [ ] è‡ªç„¶æœˆ SLA è®¡ç®—æ­£ç¡® + é”™è¯¯é¢„ç®—å¯ç»Ÿè®¡
- [ ] æ— éœ€äººå·¥å³å¯é™çº§/æ¢å¤
- [ ] å• AZ æ•…éšœæ ¸å¿ƒåŠŸèƒ½æ— æ„Ÿ
- [ ] å•†å®¶å¢é•¿/è¿‡æ»¤å»¶è¿Ÿ/å­˜å‚¨å®¹é‡å¯ç›‘æ§
- [ ] å¸¸é’èŠ‚ç‚¹æ°´ä½å‘Šè­¦ï¼ˆç»¿<2.5äº¿/é»„2.5-3äº¿/çº¢â‰¥3äº¿ï¼‰

---

## é™„å½•Aï¼šåè¯è§£é‡Š

> [è¡¨æ ¼ï¼šANNã€Bitmapã€CLIPã€DiskANNã€HNSWã€INVERTEDã€Milvusã€Refineã€RocksDBã€SQ8ç­‰æœ¯è¯­]

## é™„å½•Bï¼šå…³è”æ–‡æ¡£

| æ–‡æ¡£ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| æŠ€æœ¯æ¶æ„æ–‡æ¡£ | v1.2 | ä¸¤åŒºæ¶æ„ HNSW+DiskANN è¯¦ç»†è®¾è®¡ |
| ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ | v1.1 | ç³»ç»Ÿçº§è¯¦ç»†è®¾è®¡ |
| ä¸šåŠ¡åä½œä¸æ²»ç†è¯´æ˜ | v1.0 | å„æ–¹åä½œè§„èŒƒ |

## é™„å½•Cï¼šå˜æ›´å†å²

> [è¡¨æ ¼ï¼šv1.0 â†’ v2.0 â†’ v3.0 â†’ ... â†’ v3.9 â†’ v4.0 â†’ v4.0.1 å®Œæ•´å˜æ›´è®°å½•]
