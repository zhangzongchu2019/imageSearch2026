# 以图搜商品系统 -- 测试用例文档

**版本**: v2.0
**日期**: 2026-02-28
**关联文档**: BRD v4.0.1 / 技术架构文档 v1.3 / 系统设计文档 v1.2 / 业务协作与治理说明 v1.0
**适用范围**: QA / 研发 / SRE

---

## 一、测试策略概述

### 1.1 测试分层

| 层级 | 范围 | 工具 | 覆盖目标 | 执行频率 |
|------|------|------|---------|---------|
| 单元测试 | 函数/类级别 | pytest / JUnit 5 | >=80% 行覆盖 | 每次提交 |
| 组件测试 | 单服务 + Mock 依赖 | pytest + testcontainers | 核心路径 100% | 每次 MR |
| 集成测试 | 多服务联调 | docker-compose + pytest | 端到端场景 | 每日 / 每次发布 |
| 性能测试 | 全链路 | locust / wrk | P95/P99 达标 | 每周 / 重大变更 |
| 混沌测试 | 故障注入 | 手动 + 自动化脚本 | 降级状态机全覆盖 | 每月 |

### 1.2 测试总量汇总

| 服务 | 单元测试 | 集成测试 | 合计 | 测试文件数 |
|------|---------|---------|------|-----------|
| search-service | 193 | 19 | 212 | 22 |
| write-service | 71 | 4 | 75 | 15 |
| cron-scheduler | 29 | 7 | 36 | 8 |
| flink-pipeline | 29 | -- | 29 | 5 |
| bitmap-filter-service | 31 | 5 | 36 | 5 |
| E2E (跨服务) | -- | 5 | 5 | 4 |
| **合计** | **353** | **40** | **393** | **59** |

### 1.3 验收优先级

| 优先级 | 定义 | 测试用例数 |
|--------|------|-----------|
| P0 | 核心主干路径，阻塞发布 | 148 |
| P1 | 重要分支路径，允许已知问题 | 163 |
| P2 | 增强功能，后续迭代修复 | 82 |

---

## 二、测试用例清单

### 2.1 search-service (212 tests)

#### 2.1.1 P0 修复验收 (test_p0_fixes.py -- 12 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-001 | TimeRange 枚举值对齐 v4.0 | P0 | test_enum_values | HOT_ONLY/ALL/HOT_PLUS_EVERGREEN 三个值存在 | BRD v4.0.1 |
| TC-SS-002 | 默认 TimeRange 为 ALL | P0 | test_default_is_all | SearchRequest 默认 time_range=ALL | BRD v4.0.1 |
| TC-SS-003 | 无遗留枚举 (3m/9m) | P0 | test_no_legacy_enums | 枚举中不含 "3m"/"9m" 等旧值 | BRD v4.0.1 |
| TC-SS-004 | S1 降级使用 HOT_PLUS_EVERGREEN | P0 | test_s1_uses_hot_plus_evergreen | S1 状态: time_range=HOT_PLUS_EVERGREEN, cascade=False, fallback=False | BRD v4.0.1 §3.3.3 |
| TC-SS-005 | S2 降级使用 HOT_PLUS_EVERGREEN | P0 | test_s2_uses_hot_plus_evergreen | S2 状态: time_range=HOT_PLUS_EVERGREEN, ef_search=64, refine_top_k=500 | BRD v4.0.1 §3.3.3 |
| TC-SS-006 | S0 正常不修改参数 | P0 | test_s0_no_modification | S0 状态: time_range=ALL, cascade=True, ef_search=192 | 系统设计 §11.2 |
| TC-SS-007 | Mock 推理需 ENV 开关 | P0 | test_mock_requires_env_flag | ALLOW_MOCK=false 且无模型 -> RuntimeError | 技术架构 §3.2 |
| TC-SS-008 | Mock 推理确定性 | P0 | test_mock_deterministic | 同图同向量, model_version=mock-v0, dim=256 | 技术架构 §3.2 |
| TC-SS-009 | Proto stubs 可导入 | P0 | test_proto_stubs_importable | BatchFilterRequest/Response/Stub 存在 | 系统设计 §6.1 |
| TC-SS-010 | gRPC 不再 NotImplementedError | P0 | test_no_more_not_implemented_error | BitmapFilterGrpcClient 源码无 NotImplementedError | 系统设计 §6.1 |
| TC-SS-011 | HOT_PLUS_EVERGREEN 分区过滤 | P0 | test_hot_plus_evergreen_filter | 过滤表达式含 "is_evergreen == true" 和 "ts_month >=" | BRD v4.0.1 §4.5 |
| TC-SS-012 | ALL 使用 18m 边界 | P0 | test_all_uses_18m_boundary | 过滤表达式含 "ts_month >=" 和 "is_evergreen == true" | BRD v4.0.1 §4.5 |

#### 2.1.2 降级状态机 (test_degrade_fsm.py -- 26 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-020 | S0 正常无转移 | P0 | test_s0_normal_no_transition | P99<阈值持续300次, 状态保持 S0 | 系统设计 §11.2 |
| TC-SS-021 | S0->S1 高延迟 | P0 | test_s0_to_s1_high_latency | P99>450ms 持续 130 tick -> S1 | BRD v4.0.1 §3.3.3 |
| TC-SS-022 | S0->S2 极端延迟直通 | P0 | test_s0_to_s2_extreme_latency | P99>800ms 持续 35 tick -> S2 | BRD v4.0.1 §3.3.3 |
| TC-SS-023 | S1->S2 继续恶化 | P0 | test_s1_to_s2_worsening | 先进 S1 后注入 900ms -> S2 | BRD v4.0.1 §3.3.3 |
| TC-SS-024 | S1->S3 恢复 | P1 | test_s1_recovery_to_s3 | 驻留 5min + 指标恢复 -> S3 | 系统设计 §7.1 |
| TC-SS-025 | S3->S2 恢复中恶化 | P1 | test_s3_back_to_s2_on_worsening | S3 注入 900ms -> 回退 S2 | 系统设计 §7.1 |
| TC-SS-026 | S0->S4 人工锁定 | P1 | test_s4_manual_override | force_state(S4) -> state=S4 | 系统设计 §11.2 |
| TC-SS-027 | S4->S0 人工解锁 | P1 | test_s4_to_s0_release | force_state(S0) -> state=S0 | 系统设计 §11.2 |
| TC-SS-028 | S0 无参数覆盖 | P0 | test_s0_no_override | ef_search=192, refine_top_k=2000, fallback=True | 系统设计 §11.2 |
| TC-SS-029 | S1 参数覆盖 | P0 | test_s1_params | ef_search=128, refine_top_k=1000, fallback=False | BRD v4.0.1 §3.3.3 |
| TC-SS-030 | S2 参数覆盖 | P0 | test_s2_params | ef_search=64, refine_top_k=500, cascade=False | BRD v4.0.1 §3.3.3 |
| TC-SS-031 | RollingWindow avg_p99 | P1 | test_avg_p99 | 10 个 100ms 样本 -> avg=100.0 | 系统设计 §11.2 |
| TC-SS-032 | RollingWindow max_error_rate | P1 | test_max_error_rate | 三个样本取最大错误率 | 系统设计 §11.2 |
| TC-SS-033 | 默认 S0->S1 阈值 | P1 | test_default_s0_s1_threshold | p99=450, duration=120, err=0.0005 | 系统设计 §11.2 |
| TC-SS-034 | 默认 S0->S2 阈值 | P1 | test_default_s0_s2_threshold | p99=800, duration=30 | 系统设计 §11.2 |
| TC-SS-035 | 配置服务动态阈值 | P1 | test_threshold_from_config_service | 配置服务可用时优先读取动态值 | 系统设计 §11.2 |
| TC-SS-036 | 配置服务故障回退 | P1 | test_config_service_failure_fallback | 异常时 fallback 到静态默认值 | 系统设计 §11.2 |
| TC-SS-037 | murmurhash 同商家一致 | P1 | test_same_merchant_same_result | 同一 merchant_id 多次哈希相同 | 系统设计 §7.1 |
| TC-SS-038 | murmurhash 分布均匀 | P1 | test_different_merchants_distribute | 1000 商家覆盖 >=50 个桶 | 系统设计 §7.1 |
| TC-SS-039 | S3 灰度放量 10% | P1 | test_s3_ramp_stage_0_passes_few | stage 0 通过率约 10% | 系统设计 §7.1 |
| TC-SS-040 | murmurhash 跨语言一致性 | P2 | test_ramp_cross_language_consistency | 已知输入稳定输出 | 系统设计 §7.1 |
| TC-SS-041 ~ TC-SS-045 | 其余 5 个状态机测试 | P1/P2 | (degrade_fsm 附加用例) | 边界条件、超时恢复等 | 系统设计 §7.1 |

#### 2.1.3 Fallback 多路召回 (test_fallback.py -- 6 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-050 | 子图+标签并行召回 | P1 | test_sub_plus_tag_parallel | asyncio.gather 返回 2 个结果 | BRD v4.0.1 §5.2.1 |
| TC-SS-051 | 低分触发 fallback | P0 | test_low_score_trigger | top1_score < 0.80 -> 触发 | BRD v4.0.1 §4.4 R7 |
| TC-SS-052 | 空结果触发 fallback | P0 | test_empty_trigger | candidates=[] -> 触发 | BRD v4.0.1 §4.4 R7 |
| TC-SS-053 | 常青兜底搜索 | P1 | test_evergreen_fallback | partition_filter="is_evergreen == true" | BRD v4.0.1 §4.3 |
| TC-SS-054 | 兜底 200ms 超时 | P1 | test_200ms_timeout | asyncio.TimeoutError -> 返回空 | BRD v4.0.1 §5.2.1 |
| TC-SS-055 | 兜底失败返回空 | P1 | test_failure_returns_empty | Exception -> result=[] | BRD v4.0.1 §3.5.2 |

#### 2.1.4 搜索日志 (test_search_log_emitter.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-060 | 日志发送到 Kafka | P2 | test_emit_sends_to_kafka | send_and_wait 被调用 | 系统设计 §3.5.3 |
| TC-SS-061 | Kafka 失败不阻塞 | P1 | test_emit_kafka_failure_no_block | Exception 不向上抛 | 系统设计 §3.5.3 |
| TC-SS-062 | 日志含性能分解 | P2 | test_emit_includes_performance_breakdown | 有 feature_ms/ann_hot_ms 等字段 | 系统设计 §3.5.3 |
| TC-SS-063 | request_id 作为 Kafka key | P2 | test_emit_uses_request_id_as_key | key=request_id | 系统设计 §3.5.3 |

#### 2.1.5 生产修复 (test_production_fixes.py -- 20 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-070 | 环境变量优先级最高 | P0 | test_env_override_highest_priority | IMGSRCH_* env 覆盖缓存值 | 技术架构 §2.4 |
| TC-SS-071 | get_int 类型转换 | P1 | test_get_int | 字符串 "8080" -> 8080, 缺失用 default | 技术架构 §2.4 |
| TC-SS-072 | get_bool 解析 | P1 | test_get_bool | "true"->True, "false"->False | 技术架构 §2.4 |
| TC-SS-073 | get_secret 从 ENV | P0 | test_get_secret_from_env | IMGSRCH_SECRET_* 环境变量 | 技术架构 §2.4 |
| TC-SS-074 | 变更监听器 | P1 | test_change_listener | on_change 回调被通知 | 技术架构 §2.4 |
| TC-SS-075 | 重试首次成功 | P0 | test_succeeds_first_try | 第一次即成功返回 | 系统设计 §5.1 |
| TC-SS-076 | 重试退避后成功 | P0 | test_succeeds_after_retries | 第 3 次成功, counter=3 | 系统设计 §5.1 |
| TC-SS-077 | 重试耗尽抛异常 | P0 | test_exhausted_raises | max_retries 耗尽 -> raise | 系统设计 §5.1 |
| TC-SS-078 | 有界线程池 | P1 | test_executor_created_with_limit | max_workers=8, prefix="milvus-io" | 系统设计 §5.1 |
| TC-SS-079 | Flush 计数器重置 | P1 | test_flush_counter_resets | 触发 flush 后 counter=0 | 系统设计 §5.1 |
| TC-SS-080 | Watchdog 续约 | P0 | test_watchdog_calls_eval | eval 至少调用 1 次 | 系统设计 §5.4 |
| TC-SS-081 | gRPC client 有 close | P1 | test_bitmap_client_has_close | 存在 async close() 方法 | 系统设计 §6.1 |
| TC-SS-082 | 缺失 API Key 401 | P0 | test_missing_key_returns_401 | _verify_api_key(None) -> 401 | 系统设计 §8.1 |
| TC-SS-083 | 开发前缀 Key 可用 | P1 | test_dev_prefix_accepted | imgsrch_test_key 通过 | 系统设计 §8.1 |
| TC-SS-084 | 补偿日志写入 | P1 | test_compensation_log_written | Redis SET 含 steps_failed | 系统设计 §5.4 |
| TC-SS-085 | PushClient 单例 | P1 | test_push_client_in_deps | BitmapFilterPushClient 可实例化 | 系统设计 §6.1 |
| TC-SS-086 | trace_id W3C 格式 | P2 | test_w3c_format | 32 字符 hex | 系统设计 §8.3 |
| TC-SS-087 | trace_id 唯一性 | P2 | test_unique | 1000 个 ID 不重复 | 系统设计 §8.3 |
| TC-SS-088 | 降级指标读取不崩溃 | P1 | test_read_live_metrics_no_crash | 无 Prometheus 返回 (0.0, 0.0) | 系统设计 §11.2 |
| TC-SS-089 | TimeRange 枚举对齐确认 | P0 | test_time_range_values | 仅含 hot_only/all/hot_eg | BRD v4.0.1 |

#### 2.1.6 词表缓存 (test_vocab_cache.py -- 8 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-100 | 解码本地命中 | P0 | test_decode_local_hit | code 42 -> "shoes" | BRD v4.0.1 §8.4 |
| TC-SS-101 | 解码未命中 | P1 | test_decode_miss | 999 -> None | BRD v4.0.1 §8.4 |
| TC-SS-102 | 解码 None 输入 | P1 | test_decode_none_input | None -> None | BRD v4.0.1 §8.4 |
| TC-SS-103 | 编码本地命中 | P0 | test_encode_local_hit | "shoes" -> 42 | BRD v4.0.1 §8.4 |
| TC-SS-104 | 编码未命中 | P1 | test_encode_miss | "unknown" -> None | BRD v4.0.1 §8.4 |
| TC-SS-105 | 编码 None 输入 | P1 | test_encode_none_input | None -> None | BRD v4.0.1 §8.4 |
| TC-SS-106 | 启动预热 | P0 | test_warm_up | PG 加载后 decode/encode 可用 | BRD v4.0.1 §8.4 |
| TC-SS-107 | 刷新重载 | P1 | test_refresh_reloads | refresh 后新数据可用 | BRD v4.0.1 §8.4 |

#### 2.1.7 融合排序 (test_fusion_ranker.py -- 6 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-110 | 仅全图结果 | P1 | test_global_only | 0.4*0.9 + 0.1*1.0 = 0.46 | 技术架构 §3.4 |
| TC-SS-111 | 四路融合 | P0 | test_four_way_fusion | 0.4*0.9+0.3*0.8+0.2*0.7+0.1*1.0=0.84 | 技术架构 §3.4 |
| TC-SS-112 | 分数降序排列 | P1 | test_sorted_descending | result[0].score > result[1].score | 技术架构 §3.4 |
| TC-SS-113 | 相同 PK 去重 | P0 | test_dedup_by_pk | 3 路同 PK -> 1 个结果 | 技术架构 §3.4 |
| TC-SS-114 | 类目不匹配 | P1 | test_no_category_match | cat 权重为 0, score=0.36 | 技术架构 §3.4 |
| TC-SS-115 | 全空返回空 | P1 | test_empty_all | fuse([],[],[]) -> [] | 技术架构 §3.4 |

#### 2.1.8 检索流水线 (test_pipeline.py -- 8 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-120 | 快路径高分不级联 | P0 | test_fast_path_high_score | score>=0.80 -> 不触发级联 | BRD v4.0.1 §4.4 R8 |
| TC-SS-121 | 低分触发级联 | P0 | test_cascade_low_score | score<0.80 -> 触发级联 | BRD v4.0.1 §4.4 R8 |
| TC-SS-122 | 空热区触发级联 | P0 | test_cascade_empty_hot | candidates=[] -> 级联 | BRD v4.0.1 §4.4 R7 |
| TC-SS-123 | 候选合并去重 | P0 | test_dedup_by_pk | 3 路合并, pk1 取最高分 0.9 | 技术架构 §3.4 |
| TC-SS-124 | 置信度 HIGH | P1 | test_high | score>=0.75 & count>=10 -> HIGH | BRD v4.0.1 §4.4 |
| TC-SS-125 | 置信度 MEDIUM | P1 | test_medium | 0.50<=score<0.75 -> MEDIUM | BRD v4.0.1 §4.4 |
| TC-SS-126 | 置信度 LOW | P1 | test_low | score<0.50 -> LOW | BRD v4.0.1 §4.4 |
| TC-SS-127 | EffectiveParams 默认值 | P0 | test_defaults | ef_search=192, refine_top_k=2000, cascade=True | 系统设计 §11.2 |

#### 2.1.9 标签召回 (test_tag_recall.py -- 5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-130 | IDF Top-5 截断 | P1 | test_idf_top5_truncation | 8 个标签截取前 5 | 技术架构 §3.3 |
| TC-SS-131 | 10ms 超时 | P1 | test_10ms_timeout | TimeoutError -> [] | BRD v4.0.1 §5.2 |
| TC-SS-132 | 空标签跳过 | P1 | test_empty_tags_skip | tags_pred=[] -> result=[] | 技术架构 §3.3 |
| TC-SS-133 | 正常标签召回 | P1 | test_normal_recall | source="tag_recall" | 技术架构 §3.3 |
| TC-SS-134 | 候选源标记 | P2 | test_candidate_source_tag_recall | c.source == "tag_recall" | 技术架构 §3.3 |

#### 2.1.10 API 路由 (test_api_routes.py -- 11 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-140 | 合法请求 200 | P0 | test_valid_search_returns_200 | base64 解码成功 | BRD v4.0.1 §4.4 |
| TC-SS-141 | 非法 base64 400 | P0 | test_invalid_base64_detected | 解码抛异常 | 系统设计 §10.2 |
| TC-SS-142 | 图片超 10MB 拒绝 | P1 | test_image_size_limit_10mb | len > 10MB | BRD v4.0.1 §3.5.1 |
| TC-SS-143 | Pipeline 异常 500 | P0 | test_pipeline_exception_returns_500 | RuntimeError -> 500 | 系统设计 §10.2 |
| TC-SS-144 | Token bucket 耗尽 | P1 | test_token_bucket_exhausted | 第二次 try_acquire=False | 系统设计 §7.4 |
| TC-SS-145 | Token bucket 补充 | P1 | test_token_bucket_refills | 1s 后 try_acquire=True | 系统设计 §7.4 |
| TC-SS-146 | Token bucket 状态 | P2 | test_token_bucket_status | status 含 rate_per_second/burst_limit | 系统设计 §7.4 |
| TC-SS-147 | 缺失 API Key 401 | P0 | test_missing_api_key_should_401 | 无 header -> 401 | 系统设计 §8.1 |
| TC-SS-148 | 无效 API Key 403 | P0 | test_invalid_api_key_should_403 | 错误 key -> 403 | 系统设计 §8.1 |
| TC-SS-149 | healthz 格式 | P1 | test_healthz_format | {"status": "ok"} | 系统设计 §8.2 |
| TC-SS-150 | system/status 字段 | P1 | test_system_status_fields | 含 status/version/degrade_state/uptime_s | 系统设计 §8.2 |

#### 2.1.11 Scope 解析 (test_scope_resolver.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-160 | Redis 缓存命中 | P0 | test_redis_cache_hit | 直接返回 ["m1","m2"] | 系统设计 §4.1 |
| TC-SS-161 | PG 回源 | P0 | test_pg_fallback | Redis miss -> PG 查询 | 系统设计 §4.1 |
| TC-SS-162 | 缓存 TTL 1h | P1 | test_cache_1h_ttl | ex=3600 | 系统设计 §4.1 |
| TC-SS-163 | scope_id 不存在 400 | P1 | test_not_found_400 | HTTPException 400 | 系统设计 §10.2 |

#### 2.1.12 配置服务 (test_config_service.py -- 11 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-170 | get 缺失返回 default | P1 | test_get_returns_default_when_missing | 返回 fallback_value | 技术架构 §2.4 |
| TC-SS-171 | get_int 转换 | P1 | test_get_int_converts_correctly | 42, isinstance int | 技术架构 §2.4 |
| TC-SS-172 | get_bool 解析 | P1 | test_get_bool_parses_true | default=False | 技术架构 §2.4 |
| TC-SS-173 | get_str 返回字符串 | P1 | test_get_str_returns_string | isinstance str | 技术架构 §2.4 |
| TC-SS-174 | 环境变量覆盖 | P0 | test_env_var_overrides_config | IMGSRCH_* 优先 | 技术架构 §2.4 |
| TC-SS-175 | 审计日志返回列表 | P2 | test_audit_log_returns_list | isinstance list | 系统设计 §11.2 |
| TC-SS-176 | 审计日志 limit | P2 | test_audit_log_respects_limit | len <= 5 | 系统设计 §11.2 |
| TC-SS-177 | config_version 整数 | P2 | test_config_version_is_int | isinstance int, >=0 | 技术架构 §2.4 |
| TC-SS-178 | reload 版本递增 | P1 | test_reload_increments_version | version >= v1 | 技术架构 §2.4 |
| TC-SS-179 | 变更监听注册 | P1 | test_change_listener_registered | on_change 不抛异常 | 技术架构 §2.4 |
| TC-SS-180 | secret 缺失返回空 | P1 | test_get_secret_returns_empty_when_missing | 不抛异常 | 技术架构 §2.4 |

#### 2.1.13 Pipeline 集成场景 (test_pipeline_integration.py -- 16 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-190 | 熔断器打开返回空 | P0 | test_hot_zone_breaker_open_returns_empty | is_open=True, 请求被拒 | BRD v4.0.1 §3.5.2 |
| TC-SS-191 | 半开允许探测 | P1 | test_breaker_half_open_allows_probe | result="probe_ok" | 系统设计 §7.2 |
| TC-SS-192 | 探测失败重新打开 | P1 | test_breaker_probe_failure_reopens | state=OPEN | 系统设计 §7.2 |
| TC-SS-193 | bitmap skip 计数逻辑 | P0 | test_consecutive_skip_counter_logic | 阈值=3, force_state(S2) | 系统设计 §6.1 |
| TC-SS-194 | skip 成功重置计数 | P1 | test_skip_counter_resets_on_success | counter=1 (非 3) | 系统设计 §6.1 |
| TC-SS-195 | 低分触发级联 | P0 | test_cascade_triggered_on_low_score | should_cascade=True | BRD v4.0.1 §4.4 |
| TC-SS-196 | 高分不触发级联 | P0 | test_cascade_not_triggered_on_high_score | should_cascade=False | BRD v4.0.1 §4.4 |
| TC-SS-197 | S1 禁用级联 | P0 | test_cascade_disabled_in_s1_degrade | enable_cascade=False | BRD v4.0.1 §3.3.3 |
| TC-SS-198 | S2 禁用级联 | P0 | test_cascade_disabled_in_s2_degrade | enable_cascade=False | BRD v4.0.1 §3.3.3 |
| TC-SS-199 | S1 降低 ef_search | P0 | test_s1_reduces_ef_search | ef_search=128 | BRD v4.0.1 §3.3.3 |
| TC-SS-200 | S2 进一步降低 ef_search | P0 | test_s2_reduces_ef_search_further | ef_search=64 | BRD v4.0.1 §3.3.3 |
| TC-SS-201 | S1/S2 限制时间范围 | P0 | test_s1_s2_restrict_time_range | time_range=HOT_PLUS_EVERGREEN | BRD v4.0.1 §3.3.3 |
| TC-SS-202 | S1/S2 禁用 fallback | P0 | test_s1_s2_disable_fallback | enable_fallback=False | BRD v4.0.1 §3.3.3 |
| TC-SS-203 ~ TC-SS-205 | 其余 3 个场景 | P1 | (pipeline_integration 附加用例) | 错误恢复、边界条件 | 系统设计 §7.2 |

#### 2.1.14 Refiner 精排 (test_refiner.py -- 5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-210 | 空候选返回空 | P1 | test_empty_candidates_returns_empty | result=[] | 技术架构 §3.4 |
| TC-SS-211 | 单候选返回 | P1 | test_single_candidate_returned | len=1, pk="pk_001" | 技术架构 §3.4 |
| TC-SS-212 | 分数降序排列 | P0 | test_sorted_descending_by_score | scores 严格降序 | 技术架构 §3.4 |
| TC-SS-213 | 保留元数据 | P1 | test_preserves_candidate_metadata | source/product_id/is_evergreen 不丢失 | 技术架构 §3.4 |
| TC-SS-214 | 2000 候选性能 | P2 | test_large_candidate_set_performance | len=2000, <500ms | BRD v4.0.1 §5.2 |

#### 2.1.15 工具函数与 Schema (test_utils_and_schemas.py -- 10 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-220 | image_pk 确定性 | P0 | test_deterministic | 同 URI -> 同 PK, len=32 | 系统设计 §1.3 |
| TC-SS-221 | 不同 URI 不同 PK | P0 | test_different_uri_different_pk | pk1 != pk2 | 系统设计 §1.3 |
| TC-SS-222 | PK hex 格式 | P1 | test_hex_format | 仅含 0-9a-f | 系统设计 §1.3 |
| TC-SS-223 | month_subtract 简单 | P1 | test_simple | 202603-3=202512 | 系统设计 §5.3 |
| TC-SS-224 | month_subtract 跨年 | P1 | test_year_boundary | 202601-1=202512 | 系统设计 §5.3 |
| TC-SS-225 | month_subtract 18 月 | P1 | test_18_months | 202602-18=202408 | 系统设计 §5.3 |
| TC-SS-226 | 合法 SearchRequest | P0 | test_valid_request | top_k=50, data_scope=ALL | 系统设计 §9.1.1 |
| TC-SS-227 | top_k 范围校验 | P0 | test_top_k_range | 0/201 -> Exception | 系统设计 §10.2 |
| TC-SS-228 | scope 冲突校验 | P0 | test_scope_conflict | merchant_scope + scope_id -> Exception | 系统设计 §10.2 |
| TC-SS-229 | merchant_scope 上限 | P1 | test_merchant_scope_max | 100 个 merchant_scope 合法 | BRD v4.0.1 §4.2 |

#### 2.1.16 特征提取高级 (test_feature_extractor_advanced.py -- 5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-230 | GPU 超时 fallback CPU | P0 | test_gpu_timeout_fallback_cpu | TimeoutError -> CPU 推理 | BRD v4.0.1 §3.5.2 |
| TC-SS-231 | embedding 维度 256 | P0 | test_embedding_dim_256 | EMBEDDING_DIM==256 | 技术架构 §3.2 |
| TC-SS-232 | FeatureResult __slots__ | P2 | test_feature_result_slots | hasattr(__slots__), dim=256 | 技术架构 §3.2 |
| TC-SS-233 | 30ms 超时常量 | P1 | test_30ms_timeout | timeout==0.03 | BRD v4.0.1 §5.2 |
| TC-SS-234 | Mock 推理确定性 | P2 | test_mock_infer_deterministic | 相同 tensor -> 相同 vec | 技术架构 §3.2 |

#### 2.1.17 Bitmap gRPC 客户端 (test_bitmap_grpc_client.py -- 5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-240 | Level 0 gRPC 成功 | P0 | test_level0_success | len=2, skipped=False | BRD v4.0.1 §3.3.4 |
| TC-SS-241 | Level 0 超时 PG 回退 | P0 | test_level0_timeout_pg | skipped=False (PG 成功) | BRD v4.0.1 §3.3.4 |
| TC-SS-242 | Level 1 PG 成功 | P1 | test_level1_success | len=2, skipped=False | BRD v4.0.1 §3.3.4 |
| TC-SS-243 | Level 1 也失败 skip | P1 | test_level1_fail_skip | skipped=True, 返回全部候选 | BRD v4.0.1 §3.3.4 |
| TC-SS-244 | 无 scope 不过滤 | P1 | test_no_scope_bypass | skipped=False, 全部返回 | BRD v4.0.1 §3.3.4 |

#### 2.1.18 完整流水线 (test_pipeline_full.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-250 | 8 Stage 快路径 | P0 | test_fast_path_8stage | resp != None, request_id 正确 | BRD v4.0.1 §4.4 |
| TC-SS-251 | PipelineContext timer | P2 | test_pipeline_context_timer | timings 含 test_stage | 系统设计 §3.5.3 |
| TC-SS-252 | 合并候选去重 | P0 | test_merge_candidates_dedup | 无重复 PK, 取最高分 | 技术架构 §3.4 |
| TC-SS-253 | 合并候选降序 | P1 | test_merge_candidates_sorted | score[0] >= score[1] | 技术架构 §3.4 |

#### 2.1.19 Admin API (test_admin_api.py -- 9 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-260 | 手动锁定 S4 | P1 | test_force_state_s4_manual_lock | state=S4 | 系统设计 §11.2 |
| TC-SS-261 | S4 释放到 S0 | P1 | test_release_from_s4_to_s0 | state=S0 | 系统设计 §11.2 |
| TC-SS-262 | force_state 递增 epoch | P1 | test_force_state_updates_epoch | epoch > initial | 系统设计 §11.2 |
| TC-SS-263 | force_state 记录原因 | P1 | test_force_state_records_reason | last_reason="bitmap_all_unavailable" | 系统设计 §11.2 |
| TC-SS-264 | status 返回完整状态 | P0 | test_status_returns_full_state | 含 state/epoch/instance_id/ramp_stage 等 7 字段 | 系统设计 §11.2 |
| TC-SS-265 | 手动打开熔断器 | P1 | test_force_breaker_open | state=OPEN | 系统设计 §7.2 |
| TC-SS-266 | 手动关闭熔断器 | P1 | test_force_breaker_closed | state=CLOSED | 系统设计 §7.2 |
| TC-SS-267 | 手动半开熔断器 | P1 | test_force_breaker_half_open | state=HALF_OPEN | 系统设计 §7.2 |
| TC-SS-268 | 列出所有熔断器 | P2 | test_list_all_breakers | 含 breaker_a/breaker_b | 系统设计 §7.2 |

#### 2.1.20 行为上报 (test_behavior_reporter.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-270 | 上报发送到 Kafka | P2 | test_report_sends_to_kafka | send_and_wait 被调用 | BRD v4.0.1 §3.2 |
| TC-SS-271 | 事件格式正确 | P2 | test_report_event_format | 含 event_type/request_id/image_id/position | BRD v4.0.1 §3.2 |
| TC-SS-272 | Kafka 失败不抛异常 | P1 | test_report_kafka_failure_no_raise | Exception 不传播 | 系统设计 §3.5.3 |
| TC-SS-273 | request_id 作 Kafka key | P2 | test_report_uses_request_id_as_key | called=True | BRD v4.0.1 §3.7 |

#### 2.1.21 Bitmap skip 强制降级 (test_bitmap_skip_force_fsm.py -- 5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-280 | 阈值常量 = 3 | P0 | test_threshold_constant | BITMAP_SKIP_FORCE_DEGRADE_THRESHOLD==3 | 系统设计 §6.1 |
| TC-SS-281 | skip 计数递增 | P1 | test_counter_increments | 2 次后 counter=2 | 系统设计 §6.1 |
| TC-SS-282 | 3 次 skip 强制 S2 | P0 | test_force_s2_on_3_consecutive | force_state(S2, bitmap_filter_skipped) | 系统设计 §6.1 |
| TC-SS-283 | 成功后重置计数 | P1 | test_counter_resets_on_success | counter=0 | 系统设计 §6.1 |
| TC-SS-284 | 已 S2 不重复触发 | P1 | test_no_force_if_already_s2 | force_state 未被调用 | 系统设计 §6.1 |

#### 2.1.22 熔断器 (test_circuit_breaker.py -- 8 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-SS-290 | 初始 CLOSED | P0 | test_initial_closed | state=CLOSED, _fail_count=0 | 系统设计 §7.2 |
| TC-SS-291 | 5 次失败 OPEN | P0 | test_5_fails_opens | fail_max=5 后 state=OPEN | 系统设计 §7.2 |
| TC-SS-292 | OPEN 拒绝调用 | P0 | test_open_rejects | CircuitBreakerOpenError | 系统设计 §7.2 |
| TC-SS-293 | 超时后 HALF_OPEN | P1 | test_timeout_half_open | reset_timeout 后 state=HALF_OPEN | 系统设计 §7.2 |
| TC-SS-294 | 探测成功 CLOSED | P1 | test_probe_success_closes | result="success", state=CLOSED | 系统设计 §7.2 |
| TC-SS-295 | 探测失败重开 | P1 | test_probe_fail_reopens | state=OPEN | 系统设计 §7.2 |
| TC-SS-296 | 手动覆盖状态 | P1 | test_force_state | force_state OPEN->CLOSED | 系统设计 §7.2 |
| TC-SS-297 | 排除异常不计入 | P2 | test_exclude_exceptions | ValueError 不触发 OPEN | 系统设计 §7.2 |

#### 2.1.23 search-service 集成测试 (19 tests)

| 用例编号 | 用例名称 | 优先级 | 测试文件 | 测试函数 | 验证点 |
|---------|---------|--------|---------|---------|--------|
| TC-SS-INT-001 | 重试延迟后连接 | P0 | test_integration.py | test_retry_connects_after_delay | 第 3 次成功 |
| TC-SS-INT-002 | 重试耗尽抛异常 | P0 | test_integration.py | test_retry_exhausted_raises | ConnectionError |
| TC-SS-INT-003 | 二级去重 Redis->PG | P0 | test_integration.py | test_dedup_redis_then_pg | is_new=True |
| TC-SS-INT-004 | 去重 Redis 命中 | P0 | test_integration.py | test_dedup_redis_hit | is_new=False |
| TC-SS-INT-005 | Watchdog 续约锁 | P0 | test_integration.py | test_watchdog_renews_lock | 锁仍存在 |
| TC-SS-INT-006 | Watchdog 锁丢失停止 | P1 | test_integration.py | test_watchdog_stops_on_lock_loss | 停止续约 |
| TC-SS-INT-007 | PG 失败补偿日志 | P1 | test_integration.py | test_compensation_log_on_pg_failure | steps_failed=["pg_dedup"] |
| TC-SS-INT-008 | Flush 超时记录不吞 | P1 | test_integration.py | test_flush_timeout_logged_not_swallowed | counter=0 |
| TC-SS-INT-009 | trace_id 格式 | P2 | test_integration.py | test_trace_id_format | 32 hex chars |
| TC-SS-INT-010 | trace_id 唯一性 | P2 | test_integration.py | test_trace_id_uniqueness | 100 个不重复 |
| TC-SS-INT-011 | integration 附加用例 | P1 | test_integration.py | (附加) | 边界条件 |
| TC-SS-INT-012 | Scope 解析真实 Redis | P1 | test_scope_resolver_real.py | (2 tests) | Redis + PG 真实查询 |
| TC-SS-INT-013 | 降级 Redis 同步 | P1 | test_degrade_redis_sync.py | (2 tests) | 多实例状态同步 |
| TC-SS-INT-014 | Pipeline E2E | P0 | test_pipeline_e2e.py | (2 tests) | 端到端流水线执行 |
| TC-SS-INT-015 ~ TC-SS-INT-019 | 词表缓存真实 | P1 | test_vocab_cache_real.py | (2 tests) | 真实 PG 词表加载 |

---

### 2.2 write-service (75 tests)

#### 2.2.1 去重 (test_dedup.py -- 6 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-001 | PK 确定性 | P0 | test_pk_deterministic | 同 URI -> 同 PK, len=32 | 系统设计 §1.3 |
| TC-WS-002 | PK hex 格式 | P1 | test_pk_hex_format | 32 字符合法 hex | 系统设计 §1.3 |
| TC-WS-003 | 不同 URI 不同 PK | P0 | test_pk_differs_for_different_uris | pk1 != pk2 | 系统设计 §1.3 |
| TC-WS-004 | Redis 命中非新图 | P0 | test_redis_hit_returns_false | is_new=False | 系统设计 §5.1 |
| TC-WS-005 | Redis miss PG 命中回填 | P0 | test_redis_miss_pg_hit_returns_false | is_new=False, Redis SET ttl=7776000 | 系统设计 §5.1 |
| TC-WS-006 | 双重 miss 新图 | P0 | test_redis_miss_pg_miss_returns_true | is_new=True | 系统设计 §5.1 |

#### 2.2.2 图片下载 (test_download.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-010 ~ TC-WS-013 | 下载成功/超时/重试/格式校验 | P1 | (4 tests) | 下载、重试、格式验证 | BRD v4.0.1 §3.5.2 |

#### 2.2.3 常青分类 (test_evergreen_classify.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-020 ~ TC-WS-023 | 常青类目/非常青/边界/ts_month 赋值 | P1 | (4 tests) | is_evergreen / ts_month 正确 | BRD v4.0.1 §4.5 |

#### 2.2.4 词表编码 (test_vocab_encoding.py -- 6 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-030 ~ TC-WS-035 | category_l1/tag 编解码、不在词表拒绝 | P1 | (6 tests) | 字符串<->整数编码 | BRD v4.0.1 §8.4 |

#### 2.2.5 Milvus upsert (test_milvus_upsert.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-040 ~ TC-WS-043 | 正常写入/分区路由/幂等/字段完整 | P0 | (4 tests) | Milvus upsert 正确 | 系统设计 §5.1 |

#### 2.2.6 PG 去重写入 (test_pg_dedup_insert.py -- 3 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-050 ~ TC-WS-052 | INSERT/冲突忽略/Redis 回填 | P0 | (3 tests) | PG ON CONFLICT DO NOTHING | 系统设计 §5.1 |

#### 2.2.7 Bitmap 推送 (test_bitmap_push.py -- 5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-060 ~ TC-WS-064 | gRPC 推送/批量/超时/重试/幂等 | P1 | (5 tests) | Bitmap 推送链路 | 系统设计 §6.1 |

#### 2.2.8 锁 Watchdog (test_lock_watchdog.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-070 ~ TC-WS-073 | 续约/停止/TTL/锁丢失 | P0 | (4 tests) | 分布式锁续约 | 系统设计 §5.4 |

#### 2.2.9 补偿 (test_compensation.py -- 3 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-080 ~ TC-WS-082 | 补偿日志写入/重试/清理 | P1 | (3 tests) | 事务补偿机制 | 系统设计 §5.4 |

#### 2.2.10 写入指标 (test_write_metrics.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-090 ~ TC-WS-093 | 计数器/延迟直方图/错误率/标签 | P2 | (4 tests) | Prometheus 指标 | 系统设计 §8.2 |

#### 2.2.11 Kafka 事件 (test_kafka_event.py -- 5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-100 ~ TC-WS-104 | 商家事件发送/格式/失败处理/key/topic | P1 | (5 tests) | Kafka 商家关联事件 | 系统设计 §5.2 |

#### 2.2.12 特征提取 (test_extract_features.py -- 7 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-110 ~ TC-WS-116 | 提取成功/维度/超时/GPU fallback/向量归一化/Mock/批量 | P0 | (7 tests) | 写入侧特征提取 | 技术架构 §3.2 |

#### 2.2.13 update-image 端点 (test_update_image_endpoint.py -- 8 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-120 | 新图片 accepted | P0 | test_new_image_returns_accepted | status=accepted, is_new=True | 系统设计 §5.1 |
| TC-WS-121 | 重复图片不调 process | P0 | test_duplicate_image_returns_not_new | is_new=False, process 未调用 | BRD v4.0.1 R2 |
| TC-WS-122 | merchant 事件总发送 | P0 | test_merchant_event_always_emitted | emit 被调用 | BRD v4.0.1 R2 |
| TC-WS-123 | bind 返回 accepted | P1 | test_bind_returns_accepted | status=accepted, image_id 正确 | BRD v4.0.1 R2 |
| TC-WS-124 | bind 事件 source 正确 | P1 | test_bind_emits_correct_source | source=bind-merchant | 系统设计 §5.2 |
| TC-WS-125 | 视频写入 accepted | P1 | test_video_returns_accepted | status=accepted, frame_count=1 | BRD v4.0.1 §7.2.4 |
| TC-WS-126 | 视频 frame_pk 派生 | P1 | test_video_frame_pk_derived_from_uri | pk=sha256(video_uri+"_frame_0") | BRD v4.0.1 §7.2.4 |
| TC-WS-127 | 视频事件 source 正确 | P1 | test_video_emits_correct_source | source=update-video | 系统设计 §5.2 |

#### 2.2.14 处理流水线 (test_process_pipeline.py -- 7+ tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-130 ~ TC-WS-136 | 完整流程/去重分支/异常回滚/幂等/Milvus flush/PG 事务/bitmap push | P0 | (7+ tests) | 写入流水线编排 | 系统设计 §5.1 |

#### 2.2.15 write-service 集成测试 (test_write_e2e.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-WS-INT-001 ~ TC-WS-INT-004 | 端到端写入/可见性/幂等/错误恢复 | P0 | (4 tests) | 真实中间件联调 | BRD v4.0.1 §5.3 |

---

### 2.3 cron-scheduler (36 tests)

#### 2.3.1 分区轮转 (test_partition_rotation.py -- 9 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-CS-001 | yyyymm_subtract 正常 | P1 | test_normal | 202601-18=202407 | 系统设计 §5.3 |
| TC-CS-002 | yyyymm_subtract 跨年 | P1 | test_year_boundary | 202601-1=202512 | 系统设计 §5.3 |
| TC-CS-003 | yyyymm_subtract 整年 | P1 | test_exact_year | 202601-12=202501 | 系统设计 §5.3 |
| TC-CS-004 | yyyymm_subtract 多年 | P1 | test_multi_year | 202601-24=202401 | 系统设计 §5.3 |
| TC-CS-005 | 新月份分区创建 | P0 | test_new_month_created | create_partition 被调用 | 系统设计 §5.3 |
| TC-CS-006 | 18m 截止线 | P0 | test_cutoff_18m | 202406 < 202407 被轮转 | BRD v4.0.1 §2.6 |
| TC-CS-007 | 常青 999999 不删 | P0 | test_evergreen_999999_never_dropped | 999999 >= cutoff | BRD v4.0.1 §4.3 |
| TC-CS-008 | Release->Delete->Drop 顺序 | P0 | test_sequence_release_delete_drop | ["release","pg_delete","drop"] | 系统设计 §5.3 |
| TC-CS-009 | 失败写补偿 | P1 | test_compensation_on_failure | milvus error 不 re-raise | 系统设计 §5.4 |

#### 2.3.2 URI 清理 (test_uri_cleanup.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-CS-020 ~ TC-CS-023 | 过期 URI 清理/Redis 删除/PG 删除/空结果跳过 | P1 | (4 tests) | URI 缓存清理 | 系统设计 §5.3 |

#### 2.3.3 常青池治理 (test_evergreen_governor.py -- 7 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-CS-030 | 绿区不清理 | P1 | (test) | 常青数 < 2.5 亿无操作 | BRD v4.0.1 §2.8 |
| TC-CS-031 | 黄区月度清理 | P1 | (test) | 按 promoted_at 升序删 >5 年 | BRD v4.0.1 §2.8 |
| TC-CS-032 | 红区紧急清理 | P1 | (test) | 年限递降至 < 2.5 亿 | BRD v4.0.1 §2.8 |
| TC-CS-033 | 2 年下限保护 | P1 | (test) | 无 >2 年节点停止清理 | BRD v4.0.1 §2.8 |
| TC-CS-034 ~ TC-CS-036 | 常青统计/告警通知/边界条件 | P2 | (3 tests) | 治理逻辑边界 | BRD v4.0.1 §2.8 |

#### 2.3.4 Bitmap 对账 (test_bitmap_reconcile.py -- 5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-CS-040 ~ TC-CS-044 | PG->Bitmap 对比/差异修复/幂等/超时/告警 | P1 | (5 tests) | Bitmap 一致性对账 | 系统设计 §6.1 |

#### 2.3.5 Milvus Compaction (test_milvus_compaction.py -- 4 tests)

| 用例编号 | 用例名称 | 优先级 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-CS-050 ~ TC-CS-053 | Compaction 触发/状态查询/超时/跳过活跃分区 | P2 | (4 tests) | Milvus 压缩管理 | 技术架构 §3.1 |

#### 2.3.6 cron-scheduler 集成测试 (7 tests)

| 用例编号 | 用例名称 | 优先级 | 测试文件 | 测试数 | 验证点 |
|---------|---------|--------|---------|--------|--------|
| TC-CS-INT-001 ~ TC-CS-INT-003 | 分区轮转真实 Milvus | P0 | test_partition_rotation_real.py | 3 | 真实分区创建/删除 |
| TC-CS-INT-004 ~ TC-CS-INT-005 | 常青治理真实 PG | P1 | test_evergreen_governor_real.py | 2 | 真实常青统计 |
| TC-CS-INT-006 ~ TC-CS-INT-007 | URI 清理真实中间件 | P1 | test_uri_cleanup_real.py | 2 | 真实 Redis+PG 清理 |

---

### 2.4 flink-pipeline (29 Java tests)

#### 2.4.1 MerchantEventDeserializer (MerchantEventDeserializerTest.java -- 8 tests)

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-FK-001 ~ TC-FK-008 | JSON 反序列化/字段映射/空值处理/格式异常/merchant_id 提取/image_pk 提取/timestamp/schema 版本 | P0/P1 | (8 tests) | Kafka 消息反序列化 | 系统设计 §5.2 |

#### 2.4.2 BitmapAggregateFunction (BitmapAggregateFunctionTest.java -- 9 tests)

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-FK-010 ~ TC-FK-018 | 累加器初始化/单商家/多商家聚合/窗口合并/空累加器/商家去重/3000 商家上限/序列化/反序列化 | P0/P1 | (9 tests) | Bitmap 聚合逻辑 | 系统设计 §6.1 |

#### 2.4.3 BitmapPostgresqlSink (BitmapPostgresqlSinkTest.java -- 6 tests)

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-FK-020 ~ TC-FK-025 | PG UPSERT/批量写入/重试/连接池/失败回退/幂等 | P1 | (6 tests) | Bitmap 持久化 | 系统设计 §6.1 |

#### 2.4.4 MerchantDictEncoder (MerchantDictEncoderTest.java -- 6 tests)

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-FK-030 ~ TC-FK-035 | 商家 ID 编码/解码/范围校验/新商家自动分配/编码稳定性/缓存命中 | P1 | (6 tests) | 商家字典编码 | BRD v4.0.1 §8.4 |

---

### 2.5 bitmap-filter-service (36 Java tests)

#### 2.5.1 RocksDB 存储 (RocksDBStoreTest.java -- 7 tests)

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-BF-001 ~ TC-BF-007 | put/get/delete/批量查询/不存在返回空/TTL 过期/RocksDB 配置 | P0/P1 | (7 tests) | RocksDB KV 存储 | 系统设计 §6.1 |

#### 2.5.2 CDC Kafka Consumer (CdcKafkaConsumerTest.java -- 6 tests)

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-BF-010 ~ TC-BF-015 | 消息消费/offset 提交/反序列化/空消息跳过/批量消费/延迟监控 | P1 | (6 tests) | CDC 数据同步 | 系统设计 §6.1 |

#### 2.5.3 gRPC 过滤处理器 (BitmapFilterHandlerTest.java -- 9 tests)

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-BF-020 ~ TC-BF-028 | 单商家过滤/多商家过滤/3000 商家/空 scope/不存在图片/超时/批量请求/gRPC 状态码/性能 P99 | P0/P1 | (9 tests) | Bitmap 过滤核心 | BRD v4.0.1 §3.3.4 |

#### 2.5.4 健康检查 (HealthCheckerTest.java -- 9 tests)

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-BF-030 ~ TC-BF-038 | SERVING/DEGRADED/NOT_SERVING/CDC 延迟 <10s/10s~60s/> 60s/RocksDB 健康/磁盘空间/gRPC 健康协议 | P1/P2 | (9 tests) | 三级健康状态 | 系统设计 §6.1 |

#### 2.5.5 bitmap-filter 集成测试 (BitmapFilterIntegrationIT.java -- 5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-BF-INT-001 ~ TC-BF-INT-005 | CDC->RocksDB->gRPC 全链路/并发过滤/大 Bitmap/过滤正确性/延迟 | P0/P1 | (5 tests) | 端到端联调 | BRD v4.0.1 §3.3.4 |

---

### 2.6 E2E 跨服务测试 (5 tests)

| 用例编号 | 用例名称 | 优先级 | 测试文件 | 测试函数 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|---------|--------|---------|
| TC-E2E-001 | 写入->搜索 E2E | P0 | test_write_search_e2e.py | (1) | 写入图片后可搜索到 | BRD v4.0.1 §5.3 |
| TC-E2E-002 | 写入->搜索 幂等 E2E | P0 | test_write_search_e2e.py | (1) | 重复写入不产生重复结果 | BRD v4.0.1 R3 |
| TC-E2E-003 | 写入->Flink->Bitmap->搜索 | P0 | test_write_flink_bitmap_search.py | (1) | 全链路商家过滤 | BRD v4.0.1 §3.3.4 |
| TC-E2E-004 | 分区轮转->搜索 | P1 | test_cron_rotation_search.py | (1) | 轮转后搜索不含旧数据 | BRD v4.0.1 §2.6 |
| TC-E2E-005 | 常青治理->搜索 | P1 | test_cron_evergreen_search.py | (1) | 常青数据始终可搜索 | BRD v4.0.1 §4.3 |

---

## 三、测试代码对应关系

### 3.1 search-service

| 测试代码文件 | 路径 | 覆盖用例 | 类型 | 测试数 |
|-------------|------|---------|------|--------|
| test_p0_fixes.py | services/search-service/tests/unit/ | TC-SS-001 ~ TC-SS-012 | 单元测试 | 12 |
| test_degrade_fsm.py | services/search-service/tests/unit/ | TC-SS-020 ~ TC-SS-045 | 单元测试 | 26 |
| test_fallback.py | services/search-service/tests/unit/ | TC-SS-050 ~ TC-SS-055 | 单元测试 | 6 |
| test_search_log_emitter.py | services/search-service/tests/unit/ | TC-SS-060 ~ TC-SS-063 | 单元测试 | 4 |
| test_production_fixes.py | services/search-service/tests/unit/ | TC-SS-070 ~ TC-SS-089 | 单元测试 | 20 |
| test_vocab_cache.py | services/search-service/tests/unit/ | TC-SS-100 ~ TC-SS-107 | 单元测试 | 8 |
| test_fusion_ranker.py | services/search-service/tests/unit/ | TC-SS-110 ~ TC-SS-115 | 单元测试 | 6 |
| test_pipeline.py | services/search-service/tests/unit/ | TC-SS-120 ~ TC-SS-127 | 单元测试 | 8 |
| test_tag_recall.py | services/search-service/tests/unit/ | TC-SS-130 ~ TC-SS-134 | 单元测试 | 5 |
| test_api_routes.py | services/search-service/tests/unit/ | TC-SS-140 ~ TC-SS-150 | 单元测试 | 11 |
| test_scope_resolver.py | services/search-service/tests/unit/ | TC-SS-160 ~ TC-SS-163 | 单元测试 | 4 |
| test_config_service.py | services/search-service/tests/unit/ | TC-SS-170 ~ TC-SS-180 | 单元测试 | 11 |
| test_pipeline_integration.py | services/search-service/tests/unit/ | TC-SS-190 ~ TC-SS-205 | 单元测试 | 16 |
| test_refiner.py | services/search-service/tests/unit/ | TC-SS-210 ~ TC-SS-214 | 单元测试 | 5 |
| test_utils_and_schemas.py | services/search-service/tests/unit/ | TC-SS-220 ~ TC-SS-229 | 单元测试 | 10 |
| test_feature_extractor_advanced.py | services/search-service/tests/unit/ | TC-SS-230 ~ TC-SS-234 | 单元测试 | 5 |
| test_bitmap_grpc_client.py | services/search-service/tests/unit/ | TC-SS-240 ~ TC-SS-244 | 单元测试 | 5 |
| test_pipeline_full.py | services/search-service/tests/unit/ | TC-SS-250 ~ TC-SS-253 | 单元测试 | 4 |
| test_admin_api.py | services/search-service/tests/unit/ | TC-SS-260 ~ TC-SS-268 | 单元测试 | 9 |
| test_behavior_reporter.py | services/search-service/tests/unit/ | TC-SS-270 ~ TC-SS-273 | 单元测试 | 4 |
| test_bitmap_skip_force_fsm.py | services/search-service/tests/unit/ | TC-SS-280 ~ TC-SS-284 | 单元测试 | 5 |
| test_circuit_breaker.py | services/search-service/tests/unit/ | TC-SS-290 ~ TC-SS-297 | 单元测试 | 8 |
| test_integration.py | services/search-service/tests/integration/ | TC-SS-INT-001 ~ TC-SS-INT-011 | 集成测试 | 11 |
| test_scope_resolver_real.py | services/search-service/tests/integration/ | TC-SS-INT-012 | 集成测试 | 2 |
| test_degrade_redis_sync.py | services/search-service/tests/integration/ | TC-SS-INT-013 | 集成测试 | 2 |
| test_pipeline_e2e.py | services/search-service/tests/integration/ | TC-SS-INT-014 | 集成测试 | 2 |
| test_vocab_cache_real.py | services/search-service/tests/integration/ | TC-SS-INT-015 ~ TC-SS-INT-019 | 集成测试 | 2 |

### 3.2 write-service

| 测试代码文件 | 路径 | 覆盖用例 | 类型 | 测试数 |
|-------------|------|---------|------|--------|
| test_dedup.py | services/write-service/tests/unit/ | TC-WS-001 ~ TC-WS-006 | 单元测试 | 6 |
| test_download.py | services/write-service/tests/unit/ | TC-WS-010 ~ TC-WS-013 | 单元测试 | 4 |
| test_evergreen_classify.py | services/write-service/tests/unit/ | TC-WS-020 ~ TC-WS-023 | 单元测试 | 4 |
| test_vocab_encoding.py | services/write-service/tests/unit/ | TC-WS-030 ~ TC-WS-035 | 单元测试 | 6 |
| test_milvus_upsert.py | services/write-service/tests/unit/ | TC-WS-040 ~ TC-WS-043 | 单元测试 | 4 |
| test_pg_dedup_insert.py | services/write-service/tests/unit/ | TC-WS-050 ~ TC-WS-052 | 单元测试 | 3 |
| test_bitmap_push.py | services/write-service/tests/unit/ | TC-WS-060 ~ TC-WS-064 | 单元测试 | 5 |
| test_lock_watchdog.py | services/write-service/tests/unit/ | TC-WS-070 ~ TC-WS-073 | 单元测试 | 4 |
| test_compensation.py | services/write-service/tests/unit/ | TC-WS-080 ~ TC-WS-082 | 单元测试 | 3 |
| test_write_metrics.py | services/write-service/tests/unit/ | TC-WS-090 ~ TC-WS-093 | 单元测试 | 4 |
| test_kafka_event.py | services/write-service/tests/unit/ | TC-WS-100 ~ TC-WS-104 | 单元测试 | 5 |
| test_extract_features.py | services/write-service/tests/unit/ | TC-WS-110 ~ TC-WS-116 | 单元测试 | 7 |
| test_update_image_endpoint.py | services/write-service/tests/unit/ | TC-WS-120 ~ TC-WS-127 | 单元测试 | 8 |
| test_process_pipeline.py | services/write-service/tests/unit/ | TC-WS-130 ~ TC-WS-136 | 单元测试 | 7+ |
| test_write_e2e.py | services/write-service/tests/integration/ | TC-WS-INT-001 ~ TC-WS-INT-004 | 集成测试 | 4 |

### 3.3 cron-scheduler

| 测试代码文件 | 路径 | 覆盖用例 | 类型 | 测试数 |
|-------------|------|---------|------|--------|
| test_partition_rotation.py | services/cron-scheduler/tests/unit/ | TC-CS-001 ~ TC-CS-009 | 单元测试 | 9 |
| test_uri_cleanup.py | services/cron-scheduler/tests/unit/ | TC-CS-020 ~ TC-CS-023 | 单元测试 | 4 |
| test_evergreen_governor.py | services/cron-scheduler/tests/unit/ | TC-CS-030 ~ TC-CS-036 | 单元测试 | 7 |
| test_bitmap_reconcile.py | services/cron-scheduler/tests/unit/ | TC-CS-040 ~ TC-CS-044 | 单元测试 | 5 |
| test_milvus_compaction.py | services/cron-scheduler/tests/unit/ | TC-CS-050 ~ TC-CS-053 | 单元测试 | 4 |
| test_partition_rotation_real.py | services/cron-scheduler/tests/integration/ | TC-CS-INT-001 ~ TC-CS-INT-003 | 集成测试 | 3 |
| test_evergreen_governor_real.py | services/cron-scheduler/tests/integration/ | TC-CS-INT-004 ~ TC-CS-INT-005 | 集成测试 | 2 |
| test_uri_cleanup_real.py | services/cron-scheduler/tests/integration/ | TC-CS-INT-006 ~ TC-CS-INT-007 | 集成测试 | 2 |

### 3.4 flink-pipeline

| 测试代码文件 | 路径 | 覆盖用例 | 类型 | 测试数 |
|-------------|------|---------|------|--------|
| MerchantEventDeserializerTest.java | services/flink-pipeline/src/test/.../function/ | TC-FK-001 ~ TC-FK-008 | 单元测试 | 8 |
| BitmapAggregateFunctionTest.java | services/flink-pipeline/src/test/.../function/ | TC-FK-010 ~ TC-FK-018 | 单元测试 | 9 |
| BitmapPostgresqlSinkTest.java | services/flink-pipeline/src/test/.../function/ | TC-FK-020 ~ TC-FK-025 | 单元测试 | 6 |
| MerchantDictEncoderTest.java | services/flink-pipeline/src/test/.../util/ | TC-FK-030 ~ TC-FK-035 | 单元测试 | 6 |
| MerchantBitmapJobIT.java | services/flink-pipeline/src/test/.../integration/ | (集成) | 集成测试 | -- |

### 3.5 bitmap-filter-service

| 测试代码文件 | 路径 | 覆盖用例 | 类型 | 测试数 |
|-------------|------|---------|------|--------|
| RocksDBStoreTest.java | services/bitmap-filter-service/src/test/.../store/ | TC-BF-001 ~ TC-BF-007 | 单元测试 | 7 |
| CdcKafkaConsumerTest.java | services/bitmap-filter-service/src/test/.../sync/ | TC-BF-010 ~ TC-BF-015 | 单元测试 | 6 |
| BitmapFilterHandlerTest.java | services/bitmap-filter-service/src/test/.../grpc/ | TC-BF-020 ~ TC-BF-028 | 单元测试 | 9 |
| HealthCheckerTest.java | services/bitmap-filter-service/src/test/.../degrade/ | TC-BF-030 ~ TC-BF-038 | 单元测试 | 9 |
| BitmapFilterIntegrationIT.java | services/bitmap-filter-service/src/test/.../integration/ | TC-BF-INT-001 ~ TC-BF-INT-005 | 集成测试 | 5 |

### 3.6 E2E (跨服务)

| 测试代码文件 | 路径 | 覆盖用例 | 类型 | 测试数 |
|-------------|------|---------|------|--------|
| test_write_search_e2e.py | tests/e2e/ | TC-E2E-001 ~ TC-E2E-002 | E2E | 2 |
| test_write_flink_bitmap_search.py | tests/e2e/ | TC-E2E-003 | E2E | 1 |
| test_cron_rotation_search.py | tests/e2e/ | TC-E2E-004 | E2E | 1 |
| test_cron_evergreen_search.py | tests/e2e/ | TC-E2E-005 | E2E | 1 |

---

## 四、v1.0 用例映射说明

以下列出 v1.0 用例编号到 v2.0 的对应关系，便于追溯：

| v1.0 用例 | v2.0 对应 | 说明 |
|----------|----------|------|
| TC-SEARCH-001~005 | TC-SS-120~122, TC-SS-050~055 | 检索主干路径拆分到 pipeline + fallback |
| TC-SEARCH-010~016 | TC-SS-160~163, TC-SS-228~229, TC-SS-240~244 | 商家过滤拆分到 scope_resolver + bitmap_grpc |
| TC-SEARCH-020~024 | TC-SS-001~006, TC-SS-011~012 | 数据范围对齐到 TimeRange v4.0 枚举 |
| TC-SEARCH-040~045 | TC-SS-140~150, TC-SS-226~228 | 参数校验拆分到 api_routes + schemas |
| TC-WRITE-001~014 | TC-WS-001~006, TC-WS-120~127 | 写入链路拆分到 dedup + endpoint |
| TC-WRITE-020~024 | TC-WS-125~127 | 视频写入 |
| TC-WRITE-030~032 | TC-WS-030~035, TC-SS-100~107 | 词表编码 |
| TC-DEGRADE-001~009 | TC-SS-020~030, TC-SS-190~205 | 降级状态机 + pipeline 联动 |
| TC-FD-001~006 | TC-SS-240~244, TC-BF-020~038 | 商家过滤降级 |
| TC-EG-001~006 | TC-CS-030~036 | 常青池治理 |
| TC-BEH-001~003 | TC-SS-270~273 | 行为上报 |

---

*文档结束*
