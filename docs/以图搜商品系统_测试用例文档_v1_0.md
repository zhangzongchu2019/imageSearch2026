# 以图搜商品系统 — 测试用例文档

**版本**：v1.0  
**日期**：2026-02-08  
**关联文档**：BRD v3.9 / 技术架构文档 v1.1 / 系统设计文档 v1.0 / 业务协作与治理说明 v1.0  
**适用范围**：QA / 研发 / SRE

---

## 一、测试策略概述

### 1.1 测试分层

| 层级 | 范围 | 工具 | 覆盖目标 | 执行频率 |
|------|------|------|---------|---------|
| 单元测试 | 函数/类级别 | pytest / go test | ≥80% 行覆盖 | 每次提交 |
| 组件测试 | 单服务 + Mock 依赖 | pytest + testcontainers | 核心路径 100% | 每次 MR |
| 集成测试 | 多服务联调 | docker-compose + pytest | 端到端场景 | 每日 / 每次发布 |
| 性能测试 | 全链路 | locust / wrk | P95/P99 达标 | 每周 / 重大变更 |
| 混沌测试 | 故障注入 | 手动 + 自动化脚本 | 降级状态机全覆盖 | 每月 |

### 1.2 验收优先级

| 优先级 | 定义 | 测试用例数 |
|--------|------|-----------|
| P0 | 核心主干路径，阻塞发布 | 42 |
| P1 | 重要分支路径，允许已知问题 | 35 |
| P2 | 增强功能，后续迭代修复 | 18 |

---

## 二、测试用例清单

### 2.1 检索链路测试（TC-SEARCH）

#### 2.1.1 正常检索

| 用例编号 | 用例名称 | 优先级 | 前置条件 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|---------|------|---------|---------|
| TC-SEARCH-001 | 快路径检索 — 高置信度 | P0 | 库中存在与查询图高度匹配的图片 | query_image(高匹配图), top_k=100 | confidence=high, strategy=fast_path, results.len≥10, top1.score≥0.75 | BRD §4.4 R7/R8 |
| TC-SEARCH-002 | 慢路径检索 — 中等置信度 | P0 | 库中存在相似但非同款图片 | query_image(相似图), enable_fallback=true | confidence=medium, 0.50≤top1.score<0.75 | BRD §4.4 R8 |
| TC-SEARCH-003 | Fallback 触发 — 低置信度 | P0 | 库中无精准匹配 | query_image(弱匹配图), enable_fallback=true | confidence=low, top1.score<0.50, strategy 含子图/标签召回 | BRD §4.4 R7 |
| TC-SEARCH-004 | Fallback 关闭 | P1 | 库中无精准匹配 | enable_fallback=false | 直接返回全图结果, 不触发子图/标签召回 | BRD R8 |
| TC-SEARCH-005 | 空结果返回 | P1 | 库中完全无匹配 | query_image(完全不相关图) | HTTP 200, results=[], confidence=low（非错误） | 系统设计 §4.5 |

#### 2.1.2 商家过滤

| 用例编号 | 用例名称 | 优先级 | 前置条件 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|---------|------|---------|---------|
| TC-SEARCH-010 | 单商家过滤 | P0 | 图片关联多个商家 | merchant_scope=["m001"] | 结果仅包含 m001 关联图片 | BRD §4.2 |
| TC-SEARCH-011 | 多商家过滤 (500个) | P0 | 多商家数据就绪 | merchant_scope=[500 个 ID] | 结果仅包含 scope 内商家图片 | BRD §4.2 |
| TC-SEARCH-012 | 多商家过滤 (3000个上限) | P0 | 多商家数据就绪 | merchant_scope=[3000 个 ID] | 正常返回，P99≤300ms | BRD §4.2 |
| TC-SEARCH-013 | 商家过滤超限截断 | P1 | — | merchant_scope=[3001 个 ID] | 截断至 3000 + 响应头警告 (HTTP 200) | BRD §3.5.1 |
| TC-SEARCH-014 | 商家过滤后结果为空 | P1 | scope 内无匹配图片 | merchant_scope=[不含匹配的商家] | filter_skipped=true, confidence=low, 返回未过滤结果 | BRD §3.5.3 |
| TC-SEARCH-015 | merchant_scope_id 预注册查询 | P1 | scope_id 已注册 | merchant_scope_id="scope_001" | 等价于传入 scope 对应商家列表 | 系统设计 §4.1 |
| TC-SEARCH-016 | merchant_scope 与 merchant_scope_id 同时传入 | P1 | — | 两者同时传 | HTTP 400, 错误码 100_01_06 | 系统设计 §10.2 |

#### 2.1.3 数据范围查询

| 用例编号 | 用例名称 | 优先级 | 前置条件 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|---------|------|---------|---------|
| TC-SEARCH-020 | 仅常青查询 | P1 | 常青数据存在 | data_scope=evergreen | 仅返回 is_evergreen=true 结果, meta.data_scope=evergreen | BRD §4.5 |
| TC-SEARCH-021 | 仅滚动查询 (9m) | P1 | 滚动数据存在 | data_scope=rolling, time_range=9m | 不包含常青结果 | BRD §4.5 |
| TC-SEARCH-022 | 全量查询 (默认) | P0 | 常青+滚动数据存在 | data_scope=all (默认) | 包含常青+滚动结果 | BRD §4.5 |
| TC-SEARCH-023 | 仅滚动查询 (18m) | P1 | 18个月数据 | data_scope=rolling, time_range=18m | 近18个月滚动（不含常青） | BRD §4.5 |
| TC-SEARCH-024 | 常青查询忽略 time_range | P1 | — | data_scope=evergreen, time_range=18m | time_range 被忽略，仅查常青 | BRD R10 |

#### 2.1.4 搜索范围描述与置信度提示

| 用例编号 | 用例名称 | 优先级 | 前置条件 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|---------|------|---------|---------|
| TC-SEARCH-030 | search_scope_desc — 全平台 | P1 | — | data_scope=all, time_range=9m | meta.search_scope_desc="全平台商品（近9m + 经典款）" | BRD §3.2 |
| TC-SEARCH-031 | search_scope_desc — 商家范围 | P1 | — | merchant_scope=[500个] | meta.search_scope_desc 含 "500 个商家" | BRD §3.2 |
| TC-SEARCH-032 | search_scope_desc — 降级模式 | P0 | 系统处于 S1/S2 | 任意查询 | search_scope_desc 含 "搜索范围已缩小" | BRD §3.2 |
| TC-SEARCH-033 | search_scope_desc — 过滤跳过 | P1 | bitmap-filter 不可用 | 带 merchant_scope | search_scope_desc 含 "其他商家商品" | BRD §3.2 |
| TC-SEARCH-034 | confidence 用户提示语义 — high | P1 | top1 ≥ 0.75 | — | "找到了与图片高度一致的商品" | BRD §4.4 |
| TC-SEARCH-035 | confidence 用户提示语义 — medium | P1 | 0.50 ≤ top1 < 0.75 | — | "未找到完全同款，以下是相似款式推荐" | BRD §4.4 |
| TC-SEARCH-036 | confidence 用户提示语义 — low | P1 | top1 < 0.50 | — | "暂未找到高度相似商品，以下是同类推荐" | BRD §4.4 |

#### 2.1.5 参数校验

| 用例编号 | 用例名称 | 优先级 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|------|---------|---------|
| TC-SEARCH-040 | query_image 缺失 | P0 | 无 query_image | HTTP 400, 100_01_01 | 系统设计 §10.2 |
| TC-SEARCH-041 | query_image 超过 10MB | P1 | >10MB 图片 | HTTP 413, 100_01_02 | BRD §3.5.1 |
| TC-SEARCH-042 | top_k 超出范围 | P1 | top_k=300 | HTTP 400, 100_01_04 | 系统设计 §10.2 |
| TC-SEARCH-043 | data_scope 无效值 | P1 | data_scope="invalid" | HTTP 400, 100_01_05 | 系统设计 §10.2 |
| TC-SEARCH-044 | API Key 缺失 | P0 | 无 X-API-Key 头 | HTTP 401, 100_02_01 | 系统设计 §8.1 |
| TC-SEARCH-045 | API Key 无效 | P0 | 错误 Key | HTTP 403, 100_02_02 | 系统设计 §8.1 |

---

### 2.2 写入链路测试（TC-WRITE）

#### 2.2.1 update-image

| 用例编号 | 用例名称 | 优先级 | 前置条件 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|---------|------|---------|---------|
| TC-WRITE-001 | 新图片写入 | P0 | URI 首次出现 | uri, merchant_id, category_l1 | status=accepted, is_new=true; Milvus/PG/Redis 均有记录 | 系统设计 §5.1 |
| TC-WRITE-002 | 已有图片追加商家 | P0 | URI 已存在 | 相同 uri + 不同 merchant_id | status=accepted, is_new=false; 仅发商家关联事件 | BRD R2 |
| TC-WRITE-003 | 幂等性 — 相同请求重复 | P0 | URI 已存在 | 完全相同请求 | 结果一致，不重复特征提取 | 系统设计 §5 |
| TC-WRITE-004 | image_id 确定性 | P0 | — | 相同 URI | 多次调用返回相同 image_id = sha256(uri) 前16字节hex | 系统设计 §1.3 |
| TC-WRITE-005 | 并发写入同一 URI | P1 | URI 首次出现 | 2 个并发请求 | 仅 1 个执行提取，另 1 个等待；最终只有 1 份数据 | BRD R3 |
| TC-WRITE-006 | 常青类目图片 | P1 | category_l1 ∈ 常青列表 | category_l1="家具" | is_evergreen=true, ts_month=999999, promoted_at>0 | 系统设计 §5.1 |
| TC-WRITE-007 | 非常青类目图片 | P1 | category_l1 不在常青列表 | category_l1="服装" | is_evergreen=false, ts_month=当月YYYYMM | 系统设计 §5.1 |
| TC-WRITE-008 | 商家关联只追加 | P0 | 图片已关联 merchant_A | uri + merchant_B | 图片同时关联 A 和 B（A 未被覆盖） | BRD R2 |
| TC-WRITE-009 | product_id 可选透传 | P2 | — | uri + product_id="prod_123" | Milvus 中 product_id="prod_123", 检索时返回 | 系统设计 §3.1.1 |

#### 2.2.2 参数校验

| 用例编号 | 用例名称 | 优先级 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|------|---------|---------|
| TC-WRITE-010 | URI 缺失 | P0 | 无 uri 字段 | HTTP 400, 200_01_01 | 系统设计 §10.2 |
| TC-WRITE-011 | merchant_id 缺失 | P0 | 无 merchant_id | HTTP 400, 200_01_02 | 系统设计 §10.2 |
| TC-WRITE-012 | category_l1 不在词表 | P0 | category_l1="不存在的类目" | HTTP 400, 200_01_03 | BRD §3.5.1 |
| TC-WRITE-013 | tags 不在词表 | P1 | tags=["无效标签"] | HTTP 400 | BRD §3.5.1 |
| TC-WRITE-014 | URI 超过 2048 字符 | P2 | 超长 URI | HTTP 400 | 系统设计 §5.1 |

#### 2.2.3 update-video

| 用例编号 | 用例名称 | 优先级 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|------|---------|---------|
| TC-WRITE-020 | 正常视频写入 | P1 | video_uri(5秒以上视频) | 3 帧正确提取，各自 image_id 可查 | BRD §7.2.4 |
| TC-WRITE-021 | 视频时长 <1s | P1 | video_uri(0.5秒视频) | HTTP 400，拒绝处理 | BRD §3.5.4 |
| TC-WRITE-022 | 视频下载失败 | P1 | 不可访问的 URL | HTTP 502，重试2次后失败 | BRD §3.5.4 |
| TC-WRITE-023 | 部分帧失败 | P2 | 第2帧提取失败 | HTTP 206，返回成功帧的 frame_ids | BRD §3.5.4 |
| TC-WRITE-024 | 所有帧均失败 | P2 | 损坏的视频文件 | HTTP 500 | BRD §3.5.4 |

#### 2.2.4 词表与整数编码

| 用例编号 | 用例名称 | 优先级 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|------|---------|---------|
| TC-WRITE-030 | category_l1 字符串→整数编码 | P1 | category_l1="家具" | Milvus 中存储为整数编码 | BRD §8.4 / 系统设计 §3.1.1 |
| TC-WRITE-031 | 检索响应整数→字符串反查 | P1 | — | 检索结果中 category_l1 返回人类可读名称 | BRD §8.4 |
| TC-WRITE-032 | 标签整数编码 | P1 | tags=["红色","连衣裙"] | Milvus 中 tags 为整数数组 | BRD §8.4 |

---

### 2.3 降级状态机测试（TC-DEGRADE）

| 用例编号 | 用例名称 | 优先级 | 触发方式 | 验证点 | 对齐文档 |
|---------|---------|--------|---------|--------|---------|
| TC-DEGRADE-001 | S0→S1 预降级 | P0 | 注入 P99>350ms 持续 2min | degraded=true, time_range=3m, ef_search=96, fallback=false | BRD §3.3.3 |
| TC-DEGRADE-002 | S1→S2 强降级 | P0 | 注入 P99>800ms 持续 30s | ef_search=64, refine_top_k=200 | BRD §3.3.3 |
| TC-DEGRADE-003 | S0→S2 直通 | P1 | 注入 800ms 延迟持续 30s | 跳过 S1 直接进入 S2 | BRD §3.3.3 |
| TC-DEGRADE-004 | S2→S3 恢复中 | P1 | 恢复 Milvus，等 10min 驻留 + 5min 观察 | 灰度放量 10%→50%→100% | 系统设计 §7.1 |
| TC-DEGRADE-005 | S3→S0 完全恢复 | P1 | 继续观察 10min OK | degrade_state=S0, degraded=false | 系统设计 §7.1 |
| TC-DEGRADE-006 | S3→S2 恢复回退 | P1 | S3 阶段注入延迟 | 回退到 S2，灰度中断 | 系统设计 §7.1 |
| TC-DEGRADE-007 | S0→S4 人工锁定 | P1 | POST /admin/degrade/override | 状态=S4, 审计日志记录 | 系统设计 §11.2 |
| TC-DEGRADE-008 | S4→S0 人工解锁 | P1 | POST /admin/degrade/release | 状态=S0 | 系统设计 §11.2 |
| TC-DEGRADE-009 | 降级覆盖用户入参 | P0 | 系统 S1 状态 | 用户传 time_range=18m | 实际 time_range=3m（被覆盖） | BRD R9 |

---

### 2.4 商家过滤降级测试（TC-FILTER-DEGRADE）

| 用例编号 | 用例名称 | 优先级 | 前置条件 | 预期输出 | 对齐文档 |
|---------|---------|--------|---------|---------|---------|
| TC-FD-001 | Level 0 正常 — RocksDB | P0 | bitmap-filter 正常 | P99≤8ms, 过滤结果正确 | BRD §3.3.4 |
| TC-FD-002 | Level 1 降级 — PG | P0 | bitmap-filter 不可用 | 回退 PG 查询, P99≈10ms | BRD §3.3.4 |
| TC-FD-003 | Level 2 降级 — 跳过过滤 | P1 | bitmap-filter + PG 均不可用 | filter_skipped=true, 返回未过滤结果 | BRD §3.3.4 |
| TC-FD-004 | Level 1→Level 0 自动恢复 | P1 | RocksDB 恢复 | 自动回切到 Level 0 | BRD §3.3.4 |
| TC-FD-005 | CDC 延迟 >10s 标记 DEGRADED | P2 | CDC 延迟注入 | HealthCheck 返回 DEGRADED | 系统设计 §6.1 |
| TC-FD-006 | CDC 延迟 >60s 标记 NOT_SERVING | P2 | CDC 延迟 >60s | HealthCheck 返回 NOT_SERVING, 触发 Level 1 | 系统设计 §6.1 |

---

### 2.5 数据边界测试（TC-BOUNDARY）

| 用例编号 | 用例名称 | 优先级 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|------|---------|---------|
| TC-BOUND-001 | 每图 1 个商家 — 最小 Bitmap | P0 | 图片仅关联 1 个商家 | Bitmap 写入/查询正常 | BRD §2.4 |
| TC-BOUND-002 | 每图 3000 个商家 — 最大 Bitmap | P0 | 图片关联 3000 个商家 | Bitmap 写入/查询正常 | BRD §2.4 |
| TC-BOUND-003 | URI 128 字符上限 | P1 | URI 长度=128 | 写入正常 | BRD §2.2 |
| TC-BOUND-004 | URI 超过 128 字符 | P1 | URI 长度=129 | 系统能处理（URI 限制为2048，128 是存储优化约束） | BRD §2.2 |
| TC-BOUND-005 | 标签 8 个 (下限) | P1 | tags=[8 个有效标签] | 写入正常 | BRD §2.2 |
| TC-BOUND-006 | 标签 32 个 (上限) | P1 | tags=[32 个有效标签] | 写入正常 | BRD §2.2 |
| TC-BOUND-007 | 标签词表外 | P1 | tags=["不存在的标签"] | 写入拒绝，HTTP 400 | BRD §8.4 |
| TC-BOUND-008 | 类目词表外 | P0 | category_l1="不存在" | 写入拒绝，HTTP 400 | BRD §3.5.1 |
| TC-BOUND-009 | top_k = 1 (最小) | P2 | top_k=1 | 返回 1 条结果 | 系统设计 §9.1.1 |
| TC-BOUND-010 | top_k = 200 (最大) | P2 | top_k=200 | 返回至多 200 条结果 | 系统设计 §9.1.1 |

---

### 2.6 常青池治理测试（TC-EVERGREEN）

| 用例编号 | 用例名称 | 优先级 | 前置条件 | 预期输出 | 对齐文档 |
|---------|---------|--------|---------|---------|---------|
| TC-EG-001 | 绿区 — 不触发清理 | P1 | 常青数 < 2.5 亿 | 无清理操作 | BRD §2.8 |
| TC-EG-002 | 黄区 — 月度清理超龄节点 | P1 | 2.5 亿 ≤ 常青数 < 3 亿 | 按 promoted_at 升序删除 >5 年节点 | BRD §2.8 |
| TC-EG-003 | 红区 — 紧急清理 | P1 | 常青数 ≥ 3 亿 | 年限递降清理至 < 2.5 亿 | BRD §2.8 |
| TC-EG-004 | 2 年下限保护 | P1 | 需要清理但无 >2 年的节点 | 停止清理，告警通知 | BRD §2.8 |
| TC-EG-005 | 常青查询始终可用 | P0 | 任何降级状态 | 常青数据始终参与查询 | BRD §4.3 |
| TC-EG-006 | 常青类目新增后存量迁移 | P2 | 新增常青类目 | 存量数据 is_evergreen 翻转, ts_month=999999 | 系统设计 §5.4 |

---

### 2.7 写入可见性 SLA 测试（TC-VISIBILITY）

| 用例编号 | 用例名称 | 优先级 | 测试方法 | 目标 | 对齐文档 |
|---------|---------|--------|---------|------|---------|
| TC-VIS-001 | Level 1 可见性 (已有图 Redis 命中) | P0 | 批量写入已有图，轮询 search 直到召回 | P95 ≤ 15s | BRD §5.3 |
| TC-VIS-002 | Level 2 可见性 (含 merchant 过滤) | P0 | 含 merchant_scope 轮询直到过滤后可召回 | P95 ≤ 30s | BRD §5.3 |
| TC-VIS-003 | Level 3 可见性 (新图完整链路) | P0 | 批量写入新图，轮询 search | P95 ≤ 45s | BRD §5.3 |

---

### 2.8 性能测试（TC-PERF）

| 用例编号 | 用例名称 | 优先级 | 测试条件 | 目标 | 对齐文档 |
|---------|---------|--------|---------|------|---------|
| TC-PERF-001 | 快路径 P95 延迟 | P0 | 9 个月数据 + 常青 + 500 商家过滤 | P95 < 120ms | BRD §5.1 |
| TC-PERF-002 | 快路径 P99 延迟 | P0 | 同上 | P99 < 300ms | BRD §5.1 |
| TC-PERF-003 | QPS 峰值承载 | P0 | 持续施压 | > 100 QPS | BRD §5.1 |
| TC-PERF-004 | 查询侧特征提取 P99 | P1 | GPU 推理 | ≤ 30ms | BRD §5.2 |
| TC-PERF-005 | 商家过滤 P99 (含 gRPC) | P1 | 2000 候选 + 3000 商家 | ≤ 8ms | BRD §5.2 |
| TC-PERF-006 | Refine 精排 P99 (热区) | P1 | 热区数据 | ≤ 5ms | BRD §5.2 |
| TC-PERF-007 | Fallback 并行召回 | P1 | 子图+标签并行 | ≤ max(子图,标签) + 5ms | BRD §5.2.1 |
| TC-PERF-008 | 降级模式下无 5xx 放大 | P0 | S1/S2 状态压测 | 无 5xx 激增 | BRD §10 验收 |
| TC-PERF-009 | 写入峰值吞吐 | P1 | 集中 6 小时 | ≥ 281/秒 | 技术架构 §1.2 |

---

### 2.9 异常处理测试（TC-ERROR）

| 用例编号 | 用例名称 | 优先级 | 注入 | 预期输出 | 对齐文档 |
|---------|---------|--------|------|---------|---------|
| TC-ERR-001 | 特征提取超时 → CPU 降级 | P1 | GPU 超时 | CPU 推理执行，延迟 +~100ms | BRD §3.5.2 |
| TC-ERR-002 | Milvus 查询超时 → 降级触发 | P0 | Milvus 200ms 注入 | 触发降级状态机 | BRD §3.5.2 |
| TC-ERR-003 | Redis 缓存不可用 → PG 回退 | P1 | Redis 停机 | 回退 PG 查询，延迟 +5ms | BRD §3.5.2 |
| TC-ERR-004 | Kafka 写入失败 → WAL 兜底 | P2 | Kafka 不可用 | 本地 WAL + 异步重试 | BRD §3.5.2 |
| TC-ERR-005 | 图片下载失败 → 重试 | P1 | 图片 URL 返回 404 | 重试 2 次后返回 503 + retry-after | BRD §3.5.2 |
| TC-ERR-006 | 图片格式不支持 | P1 | 上传 BMP 格式 | HTTP 400, 200_01_05 | 系统设计 §10.2 |
| TC-ERR-007 | 限流 — 全局 QPS | P1 | 超过 500 QPS | HTTP 429, RATE_LIMITED | 系统设计 §7.4 |
| TC-ERR-008 | 限流 — 调用方 QPS | P1 | 超过调用方配额 | HTTP 429, 100_03_02 | 系统设计 §7.4 |

---

### 2.10 行为上报测试（TC-BEHAVIOR）

| 用例编号 | 用例名称 | 优先级 | 输入 | 预期输出 | 对齐文档 |
|---------|---------|--------|------|---------|---------|
| TC-BEH-001 | 正常上报 — click 事件 | P2 | {event_type:click, request_id, image_id, position} | 写入 Kafka 成功 | BRD §3.2 |
| TC-BEH-002 | 上报不阻塞主链路 | P1 | Kafka 不可用时上报 | 检索/写入不受影响 | 系统设计 §3.5.3 |
| TC-BEH-003 | request_id 关联 | P2 | 搜索后上报 | ClickHouse 中 search_log JOIN behavior_log 可关联 | BRD §3.7 |

---

## 三、测试代码对应关系

| 测试代码文件 | 覆盖用例 | 类型 |
|-------------|---------|------|
| `test_search_api.py` | TC-SEARCH-001~045 | 单元+组件测试 |
| `test_write_api.py` | TC-WRITE-001~032 | 单元+组件测试 |
| `test_degrade_fsm.py` | TC-DEGRADE-001~009 | 单元测试 |
| `test_bitmap_filter.py` | TC-FD-001~006 + TC-BOUND-001~002 | 单元+组件测试 |
| `test_fusion_ranker.py` | 融合排序逻辑 | 单元测试 |
| `test_evergreen.py` | TC-EG-001~006 | 单元+组件测试 |
| `test_integration_e2e.py` | 端到端场景 | 集成测试 |
| `test_performance.py` | TC-PERF-001~009 | 性能测试 (locust) |
