# 以图搜商品系统 · 业务协作与治理说明

**版本**：v1.1
**日期**：2026-02-28
**状态**：更新发布
**适用范围**：CTO / 产品负责人 / 合作方业务线 / 域架构师 / 项目经理
**定位**：本文档是图搜系统的**对外协作契约**，面向图搜团队以外的所有利益相关方。技术实现细节请参阅《技术架构文档 v1.3》，业务需求规格请参阅《业务需求文档 v4.0.1》。

---

> **阅读指引**
>
> - 第一部分（§1-§4）面向 **CTO / 产品负责人**：定义系统的业务主语、前置假设、策略归属和使用约束
> - 第二部分（§5-§11）面向 **合作方业务线**：定义依赖等级、接口语义边界、降级责任、变更约定和接入指南
> - 合作方快速接入请直接跳转 §11

---

# 第一部分：业务治理声明

> 面向 CTO / 产品负责人 / 架构评审委员会

---

## §1 核心业务主语声明

图搜系统的检索单元是 **image（图片）**，不是 product（商品）。理解这一点是正确使用系统的前提。

### 1.1 实体语义定义

| 实体 | 在图搜系统中的含义 | ≠ 以下概念 |
|------|-------------------|-----------|
| **image** | 一张图片的视觉内容，由 URI 唯一标识，image_id = SHA256(uri) | ≠ 商品（product）、≠ SKU、≠ 素材（content） |
| **image_id** | 图片的确定性唯一标识（CHAR(32)），同一 URI 永远产生相同 ID | ≠ 商品 ID、≠ 素材 ID |
| **merchant_id** | 与图片关联的商家字符串 ID，表示"该商家使用了这张图片" | ≠ 可售商家、≠ 授权商家、≠ 可见商家 |
| **product_id** | 写入时调用方携带的**可选透传字段**，图搜系统不维护 image→product 映射 | ≠ 系统推荐的商品、≠ 稳定的商品标识 |

### 1.2 image 与 product 的关系

```
一张 image 可以被多个 merchant 使用（1:N 关联）
一个 merchant 可以将同一 image 关联到不同 product
图搜系统不感知也不管理 image↔product 的绑定关系

因此：
  image_id  → 稳定（SHA256 确定性）
  product_id → 不稳定（依赖写入时的调用方传入值）
```

### 1.3 关键推论

- 图搜检索返回的是 **image_id + score（相似度排序列表）**，不是商品推荐列表
- 从 image_id 到可售商品的映射，是**调用方的责任**，不在图搜系统范围内
- product_id 仅为便利性透传，不保证跨请求、跨 merchant_scope、跨策略版本稳定

---

## §2 阶段性业务假设

以下假设是当前系统设计的前提。当假设被挑战时，需要重新评估受影响的设计。

### 2.1 商家关联不可逆（只追加、不删除）

**当前假设**：图片一旦被某商家关联，不可取消关联。关联关系仅通过图片 TTL 自然过期消失。

**假设合理性依据**：

| 潜在挑战场景 | 当前处理机制 | 为何不需要主动解绑 |
|-------------|------------|-------------------|
| 授权关系解除 | 图片 18 个月 TTL 自然过期 | 时间窗口可接受 |
| 违规图片下架 | 在内容域/商品域处理 | 图搜不是源头系统 |
| 商家退出/冻结 | 查询侧 merchant_scope 自然排除 | 冻结商家不在查询 scope 中 |
| 商品停售 | 同上 | 不影响图片层面的商家关联 |

**假设破坏条件**（出现以下情况需重新评估）：

- 图搜结果直接用于供给分析/选品决策（关联准确性要求提升）
- 商家主动要求从特定图片中"解绑"（隐私/合规驱动）
- 常青图片生命周期远超 18 个月，累积的过时关联影响过滤质量

**预留能力**：技术上可通过引入 REMOVE 事件 + rb_andnot() 实现解绑，预估改造量 2-3 人周。此需求出现前不主动实现。

> 详见 BRD v4.0.1 §2.4「商家关联不可逆假设声明」

### 2.2 图搜不承担交易责任

图搜系统是**增强型商品发现能力**，设计原则为"可降级、可关闭"。

| 声明 | 说明 |
|------|------|
| 图搜结果不代表可售状态 | 返回的 image_id 不等于"该商品当前可购买" |
| 图搜不校验库存/价格/上架状态 | 这些属于商品域职责 |
| 图搜完全不可用时核心交易不受影响 | 搜索结果页、商品详情页、下单支付均有独立路径 |
| 图搜 SLA 不为交易链路兜底 | 将图搜作为交易关键路径的场景需自行承担风险 |

---

## §3 策略 Owner 声明

### 3.1 常青策略 RACI

| 决策项 | R（执行） | A（审批） | C（咨询） | I（知会） |
|--------|---------|---------|---------|---------|
| 常青类目列表变更（新增类目） | 产品经理 | CTO | 算法团队 | 研发、SRE |
| 常青池水位治理（清理执行） | SRE | 研发负责人 | 产品经理 | — |
| 常青池硬上限调整（≤3 亿） | 架构组 | CTO | 研发、SRE、产品 | 全员 |
| 存量迁移（已有图片标记为常青） | 研发 + SRE | 研发负责人 | 产品经理 | — |

**决策升级路径**：

- 常规清理（绿/黄区）：系统自动执行，产品知会
- 红区清理：产品确认后执行
- 2 年以上全删仍超限：升级至 CTO 决策

### 3.2 召回质量相关性定义归属

Recall / Precision 指标的前提是对"相关"的明确定义。

| 职责 | Owner | 说明 |
|------|-------|------|
| "相关"的业务定义（标注指南） | 产品经理 + 算法负责人 | 定义何为"同款"/"相似款"/"不相关" |
| 黄金集（Golden Set）构建 | 算法团队 | 规格见技术架构文档 v1.3 §12.2 |
| 黄金集标注质量审核 | 产品经理 | 抽样审核标注结果 |
| Recall / Precision 评测执行 | QA + 算法 | QA 执行流程，算法解读结果 |
| 融合排序权重调优 | 算法团队 | 通过 A/B 实验优化 |

**联合诊断原则**：指标不达标时，图搜研发排查技术层面（索引参数、降级影响），算法排查模型层面（向量质量、标签覆盖），产品确认业务预期是否合理。三方联合诊断，不由任一方单独承担。

---

## §4 使用约束声明

### 4.1 禁止行为

| 约束 | 说明 | 违反后果 |
|------|------|---------|
| ❌ 禁止将图搜作为唯一商品发现入口 | 图搜为增强能力，不替代关键词搜索/类目导航 | 图搜降级时无任何发现能力 |
| ❌ 禁止将 image_id/product_id 直接用于交易决策 | 图搜返回相似度排序，不保证可售状态 | 库存/价格不一致导致交易异常 |
| ❌ 禁止高频轮询检索接口 | 单调用方 QPS 上限由接入时约定（默认 50 QPS） | 超限触发限流 429 |
| ❌ 禁止绕过 merchant_scope 做全平台爬取 | merchant_scope 为空仅适用于平台运营场景 | 发现后封禁 API Key |

### 4.2 接入方承诺

接入图搜能力的业务线应：

1. 在图搜不可用时有兜底方案（如关键词搜索、人工推荐）
2. 不将 confidence=low 的结果用于自动化决策
3. 定期与图搜团队对齐接口使用方式，避免语义误用
4. 了解并接受本文档声明的所有语义边界

---

# 第二部分：合作方协作契约

> 面向其他业务线的架构师 / 业务负责人 / 项目经理

---

## §5 系统定位与依赖等级

### 5.1 系统定位

图搜系统是 SZWEGO 平台的**增强型商品发现能力**，不是交易关键路径。

- **最好情况**：用户通过图搜快速找到相似商品，提升发现效率
- **最坏情况**：图搜完全关闭，用户通过关键词搜索、类目导航等传统方式发现商品，核心交易不受影响

### 5.2 依赖等级定义

调用方应根据自身业务关键性声明依赖等级：

| 依赖等级 | 定义 | 图搜不可用时的影响 | 图搜承诺 | 调用方要求 | 示例场景 |
|---------|------|-------------------|---------|-----------|---------|
| **L1 弱依赖** | 图搜不可用时业务完全正常 | 无影响 | 99.99% SLA（核心） | 有独立 fallback | 搜索结果页"找相似"按钮 |
| **L2 强依赖** | 图搜不可用时体验下降但业务可用 | 关键场景受影响 | 99.5% SLA（完整） | 降级方案可接受 | 选品工具的"以图找货" |
| **L3 关键依赖** | 图搜不可用时业务不可用 | ❌ 业务中断 | ❌ **不支持** | **禁止** | 交易页唯一推荐源 |

> **v1.1 实现状态说明**：当前代码未跟踪调用方的依赖等级（L1/L2/L3），调用方自行声明。系统侧通过 API Key 区分调用方，但不强制依赖等级验证。

**重要声明**：

- 任何将图搜作为 L3 关键依赖的场景，需自行承担降级与不可用风险
- 图搜团队有权拒绝为 L3 场景提供定制化 SLA
- 新业务线接入前，需与图搜团队确认依赖等级

---

## §6 返回结果的业务语义边界

### 6.1 image_id — 稳定标识 ✅

同一张图片永远返回相同 image_id（SHA256 确定性生成）。

**可安全用于**：去重、缓存、日志关联、二次查询

### 6.2 product_id — 不稳定透传 ⚠️

图搜系统**不维护** image→product 映射。product_id 来自写入时调用方携带的元数据。

| 特性 | 说明 |
|------|------|
| ❌ 不保证跨请求稳定 | 不同 merchant_scope 可能返回不同结果集 |
| ❌ 不保证跨 merchant_scope 稳定 | 同一图片在不同商家上下文中可能关联不同商品 |
| ❌ 不保证跨策略版本稳定 | 模型迭代/权重调整可能改变排序 |
| ❌ 不可用于交易决策 | 不代表当前可售商品 |

**正确使用方式**：如需从 image_id 获取当前可售商品，应自行查询商品域服务。图搜仅提供 image_id + score 作为召回依据。

### 6.3 score / confidence — 相对排序

| 字段 | 语义稳定性 | 使用建议 |
|------|-----------|---------|
| score | ❌ 跨模型版本不可比 | 不要硬编码阈值做业务判断 |
| confidence (high/medium/low) | ✅ 枚举语义稳定 | 可用于前端展示用户提示 |

### 6.4 is_evergreen — 稳定标记 ✅

表示该图片是否来自常青池，语义稳定，可用于业务逻辑。

---

## §7 merchant_scope 的含义说明

### 7.1 语义定义

`merchant_scope` 是检索请求参数，含义为"希望在哪些商家范围内搜索"。

### 7.2 语义辨析

| 概念 | 在图搜中的含义 | ≠ 以下概念 |
|------|-------------|-----------|
| merchant_scope（查询参数） | 调用方传入的商家 ID 列表 | ≠ 可售商家（交易域定义） |
| | 图搜仅做 Bitmap 交集过滤 | ≠ 授权商家（合规域定义） |
| | 不校验商家状态（冻结/退出等） | ≠ 可见商家（搜索域定义） |
| | | ≠ 绑定商家（商品域定义） |

### 7.3 边界情况说明

| 情况 | 图搜行为 | 调用方注意事项 |
|------|---------|-------------|
| merchant_scope 为空 | 返回全平台结果（不做商家维度过滤） | 仅适用于平台运营场景 |
| scope 包含已冻结/退出商家 | 仍然返回匹配结果 | **调用方有责任过滤非法商家** |
| scope 包含从未使用过图搜的商家 | 该商家无匹配结果 | 正常行为 |

**设计意图**：图搜系统不承担"商家状态管理"职责。商家是否可售/可见/已授权，由调用方根据自身域逻辑决定后再传入 scope。图搜只负责"在给定范围内找相似图片"。

---

## §8 降级/不可用时的合作方责任

### 8.1 降级感知方式

调用方可通过以下方式感知图搜降级状态（任选一种）：

| 方式 | 实现 | 推荐程度 |
|------|------|---------|
| **A. 响应级感知**（推荐） | 检查每个响应的 `meta.degraded` 字段 | ⭐⭐⭐ |
| **B. 系统级轮询** | 轮询 `GET /api/v1/system/status`（建议 30s 间隔） | ⭐⭐ |
| **C. Webhook 订阅** | 图搜团队配置，推送状态变更事件（v1.2 规划） | ⭐ |

> **v1.1 实现状态**：方式 A（响应级感知 meta.degraded）✅ 已实现；方式 B（GET /system/status）✅ 已实现；方式 C（Webhook 订阅）🔲 规划中。

### 8.2 降级时调用方应做什么

| 响应标记 | 含义 | 建议动作 |
|---------|------|---------|
| `meta.degraded = false` | 正常模式 | 正常使用 |
| `meta.degraded = true` | 降级模式，结果范围已缩小（仅近 3 月 + 常青） | 可正常展示，建议提示用户 |
| `meta.filter_skipped = true` | 商家过滤异常跳过 | 结果可能包含 scope 外商品，**调用方应自行二次过滤或降级展示** |
| HTTP 503 持续返回 | 图搜完全不可用 | 切换到 fallback 方案 |

> **v1.1 补充**：系统额外提供以下运维管理 API（非合作方使用）：
> - `GET /admin/degrade/status` — 降级状态查询（含 FSM epoch、窗口指标）
> - `POST /admin/degrade/override` — 人工锁定降级（S4 状态）
> - `POST /admin/degrade/release` — 解除人工锁定
> - `GET /admin/breakers` — 熔断器状态查询
> - `POST /admin/breakers/{name}/force` — 熔断器手动控制
> - `POST /admin/config/reload` — 配置热更新
> - `GET /admin/config/audit` — 配置变更审计日志

### 8.3 责任边界

- 图搜团队：保障 SLA 承诺，降级时主动通知
- 调用方：自行维护 fallback 方案，不可因"无 fallback"而要求图搜承担业务损失

### 8.4 大面积降级通知

| 降级等级 | 通知时机 | 通知渠道 |
|---------|---------|---------|
| S2（强降级）持续 > 5min | 实时 | 企微群 oncall 通知 |
| S4（人工锁定） | 提前通知 | 企微群 + 邮件 |
| 分区维护窗口 | 每月 1 日 00:00，提前 1 天 | 企微群 |

---

## §9 策略变更与兼容性约定

### 9.1 变更分级与通知

图搜系统可能在不通知调用方的情况下做内部优化，但以下变更会提前通知：

| 变更类型 | 示例 | 提前通知 | 灰度策略 |
|---------|------|---------|---------|
| 模型迭代 | 新 embedding 模型上线 | ≥ 7 天 | 10%→50%→100%，观察期 ≥ 3 天 |
| 权重调整 | 融合排序权重变化 | ≥ 3 天 | A/B 实验，不影响未参与方 |
| 常青类目变更 | 新增/调整常青类目 | ≥ 3 天 | 灰度验证后全量 |
| 索引参数调整 | ef_search / HNSW M 变化 | ≥ 1 天 | 分区级灰度 |
| 接口新增字段 | 响应增加 optional 字段 | ≥ 3 天 | 向后兼容，旧客户端无感 |
| 接口非兼容变更 | 字段语义修改 | ≥ 30 天 | 新版本接口，旧版本保留 6 个月 |

### 9.2 调用方自保机制

以下做法可以帮助调用方降低策略变更对自身业务的影响：

- **不要**硬编码 score 阈值做业务判断 → 使用 confidence 枚举（high/medium/low）
- **不要**依赖 results 顺序以外的排序稳定性
- **不要**缓存图搜结果超过 24 小时 → 策略变更后缓存可能过时
- **建议**接入行为上报 → 策略变更时可针对性评估对你的影响

### 9.3 Version Pin（规划中）

未来将支持 `strategy_version` 参数，允许调用方锁定特定策略版本。当前版本不支持，调用方应通过 A/B 实验平台评估策略变更影响。

> **v1.1 更新**：此功能仍处于规划阶段，当前代码未实现 `strategy_version` 参数。

---

## §10 行为上报：边界与承诺

### 10.1 性质

行为上报（impression / click / inquiry / order / negative_feedback）是**可选增强能力**，不是必须的。

| 维度 | 说明 |
|------|------|
| 不上报的后果 | 不影响基础检索能力（结果不会变差） |
| 上报的收益 | 图搜质量评估更准确，模型迭代方向更贴近真实使用 |

### 10.2 数据使用边界

| 用途 | 是否允许 |
|------|---------|
| ✅ 图搜检索质量评估（CTR/跳出率/负反馈率） | 允许 |
| ✅ 图搜自身模型训练与优化 | 允许 |
| ❌ 反向影响调用方业务策略 | 禁止 |
| ❌ 提供给第三方或其他业务线 | 禁止 |
| ❌ 用于商家画像/用户画像/广告投放 | 禁止 |

### 10.3 数据安全

| 维度 | 规格 |
|------|------|
| PII | 行为数据仅关联 request_id，不含用户身份信息 |
| 数据留存 | 90 天滚动（ClickHouse），到期自动清理 |
| 访问权限 | 仅图搜团队有权查询，不对外开放 |

---

## §11 合作方接入指南

### 11.1 最简接入（5 分钟）

```
1. POST /api/v1/image/search
   Body: { "query_image": "<base64>" }

2. 获取响应中的 results[].image_id + results[].score

3. 用 image_id 去商品域查询商品信息

→ 完成。不需要理解 Milvus / Bitmap / 常青的内部实现。
```

### 11.2 推荐接入（增强体验）

| 增强项 | 做法 | 效果 |
|--------|------|------|
| 按商家范围搜索 | 传入 `merchant_scope` | 只返回指定商家范围内的结果 |
| 展示用户提示 | 读取 `meta.confidence` | high→"高度一致" / medium→"相似推荐" / low→"同类推荐" |
| 降级感知 | 检查 `meta.degraded` | 降级时调整 UI 提示 |
| 展示搜索范围 | 读取 `meta.search_scope_desc` | 向用户展示当前搜索覆盖面 |
| 质量优化 | 接入行为上报 | 帮助图搜优化模型 |

### 11.3 常见误用（别踩这些坑）

| ❌ 误用 | ✅ 正确做法 |
|---------|-----------|
| 把 product_id 当作稳定商品标识 | 用 image_id 去商品域查询 |
| 把 score 跨版本比较 | 用 confidence 枚举 |
| 无 fallback 时将图搜作为唯一数据源 | 始终保留关键词搜索等替代路径 |
| 缓存图搜结果超过 24h | 策略变更后缓存可能过时 |
| 假设 merchant_scope = 可售范围 | scope 仅是过滤参数，不校验商家状态 |
| 用 confidence=low 结果做自动化决策 | low 仅适合人工浏览场景 |

### 11.4 接入审批流程

```
1. 与图搜团队确认依赖等级（§5）
2. L2（强依赖）以上需提供降级方案文档
3. 联调环境测试通过
4. 生产灰度接入
```

---

## §12 实现状态与代码对齐（v1.1 新增）

本节记录治理声明与代码实现的对齐状态。

### 12.1 已在代码中体现的治理机制

| 治理声明 | 文档章节 | 代码实现 | 验证方式 |
|---------|---------|---------|---------|
| image_id 确定性 (SHA256) | §1.1 | write-service: sha256(uri) 前16字节hex | 单元测试 test_dedup.py |
| 商家关联只追加不删除 | §2.1 | Kafka ADD 事件 + rb_or() 合并 | 单元测试 test_kafka_event.py |
| 降级响应 meta.degraded | §8.1 | routes.py 检索响应 meta 字段 | 单元测试 test_pipeline.py |
| filter_skipped 标记 | §8.2 | bitmap_filter_client.py Level 2 降级 | 单元测试 test_bitmap_grpc_client.py |
| 行为上报不阻塞主链路 | §10.1 | behavior_reporter.py Kafka 异步 | 单元测试 test_behavior_reporter.py |
| confidence 枚举稳定 | §6.3 | schemas.py HIGH/MEDIUM/LOW | 单元测试 test_pipeline.py |
| 常青池三区治理 | §3.1 | cron-scheduler evergreen_pool_check() | 单元测试 test_evergreen_governor.py |
| API Key 认证 | §4.1 | routes.py X-API-Key 校验 | 单元测试 test_api_routes.py |

### 12.2 尚未在代码中体现的治理机制

| 治理声明 | 文档章节 | 状态 | 说明 |
|---------|---------|------|------|
| 依赖等级 L1/L2/L3 跟踪 | §5.2 | 🔲 未实现 | 需在 API Key 管理中关联依赖等级 |
| strategy_version 锁定 | §9.3 | 🔲 规划中 | 文档已标注为规划中 |
| 灰度发布通知 (Webhook) | §8.1 | 🔲 规划中 | 文档标注 v1.2 规划 |
| 模型迭代灰度 10%→50%→100% | §9.1 | 🔲 未实现 | 无 A/B 测试基础设施 |

### 12.3 测试覆盖统计

| 服务 | 单元测试 | 集成测试 | 合计 |
|------|---------|---------|------|
| search-service | 193 | 19 | 212 |
| write-service | 71 | 4 | 75 |
| cron-scheduler | 29 | 7 | 36 |
| flink-pipeline (Java) | 29 | — | 29 |
| bitmap-filter-service (Java) | 31 | 5 | 36 |
| E2E 跨服务 | — | 5 | 5 |
| **合计** | **353** | **40** | **393** |

---

# 附录

## 附录A：文档间关系

```
┌─────────────────────────────────┐
│  业务需求文档 (BRD) v4.0.1      │ ← 需求规格（What）
│  适用：研发 / 测试 / 运维       │
└──────────────┬──────────────────┘
               │
┌──────────────┴──────────────────┐
│  技术架构文档 v1.3              │ ← 技术设计（How）
│  适用：研发 / SRE / 架构评审    │
└──────────────┬──────────────────┘
               │
┌──────────────┴──────────────────┐
│  业务协作与治理说明 v1.1        │ ← 协作契约（Who/When/Rules）
│  适用：CTO / 产品 / 合作方      │  ← 本文档
└─────────────────────────────────┘
```

| 关注点 | 应查阅 |
|--------|--------|
| 接口字段明细、请求/响应 Schema | BRD v4.0.1 §7 |
| SLA 数值、降级触发条件 | BRD v4.0.1 §6 |
| 系统内部架构、存储方案 | 技术架构文档 v1.3 |
| 谁负责什么、怎么协作、使用规则 | 本文档 |

## 附录B：术语对照

| 术语 | 定义 |
|------|------|
| 依赖等级 | 调用方对图搜系统的依赖程度分级：L1 弱 / L2 强 / L3 关键（禁止） |
| merchant_scope | 检索请求参数，调用方传入的商家 ID 列表，用于 Bitmap 交集过滤 |
| product_id | 写入时调用方携带的可选透传字段，图搜不维护其业务正确性 |
| confidence | 检索结果置信度枚举（high/medium/low），语义稳定 |
| degraded | 响应 meta 字段，表示系统是否处于降级模式 |
| filter_skipped | 响应 meta 字段，表示商家过滤是否异常跳过 |
| 常青节点 | 不受 18 个月 TTL 限制、长期保留的高价值图片数据层 |
| RACI | 责任分配矩阵：R=执行、A=审批、C=咨询、I=知会 |
| 黄金集 | 用于评测 Recall/Precision 的标准标注数据集 |
| SLA | Service Level Agreement，服务等级协议 |

## 附录C：变更历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2026-02-07 | 初始版本。合并五视角评审中业务评审（§1-§4）和合作方评审（§5-§11）的建议，形成图搜系统首份对外协作契约文档。 | - |
| v1.1 | 2026-02-28 | 实现状态对齐：更新 BRD 引用至 v4.0.1；新增 §12 代码对齐状态（8 项已实现 + 4 项未实现）；§8 补充 Admin API 列表；更新所有关联文档版本号。 | - |
